{"componentChunkName":"component---src-templates-blogs-post-js","path":"/blog/2022/switch-is-faster-than-if/","result":{"data":{"site":{"siteMetadata":{"title":"David Kröll"}},"markdownRemark":{"id":"b9a9cc2f-5533-57f3-8c0d-4a39537bfcc9","excerpt":"C# does support multiple control structures such as , , , ,  (and some more).\nWith a control structure you can split your code in multiple…","rawMarkdownBody":"\nC# does support multiple control structures such as `if`, `else`, `switch`, `while`, `for` (and some more).\nWith a control structure you can split your code in multiple possible paths, based on a codition.\n\n\n![A general graphical representation of a control structure](control-structure.png)\n\n*A general graphical representation of a control structure*\n\nThe `if` and `switch` statements are very well-known and adopted in most programming languages nowadays.\nThey are also often applied for the same use-case.\n\n# The experiment\n\nGiven a three-digit string of month names, like `Jan`, `Feb`, `Mar`, ... we want to get the corresponding month number as integer.\nThe results would be: `Jan = 1`, `Feb = 2`, `Mar = 3` and so on.\n\n### The if-implementation\n\nThis is the baseline implementation with `if` and `return`.\n\n```csharp\nprivate int GetMonthIndexIf(string month)\n{\n    if (month == \"Jan\")\n    {\n        return 1;\n    }\n\n    if (month == \"Feb\")\n    {\n        return 2;\n    }\n\n    if (month == \"Mar\")\n    {\n        return 3;\n    }\n    // and so on\n}\n```\n\n### The switch-implementation\n\nThis is the equivalent implementation with a `switch` statement.\n\n```csharp\nprivate int GetMonthIndexSwitch(string month)\n{\n    return month switch\n    {\n        \"Jan\" => 1,\n        \"Feb\" => 2,\n        \"Mar\" => 3,\n        \"Apr\" => 4,\n        \"May\" => 5,\n        \"Jun\" => 6,\n        \"Jul\" => 7,\n        \"Aug\" => 8,\n        \"Sep\" => 9,\n        \"Okt\" => 10,\n        \"Nov\" => 11,\n        \"Dez\" => 12,\n        _     => throw new ArgumentException(),\n    };\n}\n```\n\n> The syntax used above is called a **switch expression**.\nThis is available since C# 8.0, see: [MSDN Docs](https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/operators/switch-expression)\n\n### The Dictionary-implementation\n\nFor reference, I've also created an implementation based on a `Dictionary<string, int>`.\n\n```csharp\nprivate int GetMonthIndexDictionary(string month)\n{\n    // _monthsDict maps the month name to the index\n    return _monthsDict[month];\n}\n```\n\n\n## Benchmark setup\n\nI'm using `BenchmarkDotNet` for running the benchmarks.\nFor every `GetMonthIndex*` method, all months from `Jan` to `Dez` are called `N` times,\nto cover every path of these methods.\nThe benchmark is executed three times, for `N=1, 10, 100`.\n\n\n## Benchmark results\n\n\n```bash\nBenchmarkDotNet=v0.13.1, OS=Windows 10.0.19044.1645 (21H2)\nIntel Core i7-8650U CPU 1.90GHz (Kaby Lake R), 1 CPU, 8 logical and 4 physical cores\n.NET SDK=6.0.104\n  [Host]     : .NET 6.0.4 (6.0.422.16404), X64 RyuJIT\n  DefaultJob : .NET 6.0.4 (6.0.422.16404), X64 RyuJIT\n\n\n|                   Method |   N |        Mean |     Error |    StdDev |\n|------------------------- |---- |------------:|----------:|----------:|\n|     GetMonthIndex_Switch |   1 |    173.7 ns |   0.77 ns |   0.72 ns |\n|         GetMonthIndex_If |   1 |    485.6 ns |   3.13 ns |   2.78 ns |\n| GetMonthIndex_Dictionary |   1 |    325.8 ns |   1.70 ns |   1.42 ns |\n|     GetMonthIndex_Switch |  10 |    960.9 ns |   5.56 ns |   5.20 ns |\n|         GetMonthIndex_If |  10 |  2,528.3 ns |  15.35 ns |  14.36 ns |\n| GetMonthIndex_Dictionary |  10 |  1,793.8 ns |  25.68 ns |  22.77 ns |\n|     GetMonthIndex_Switch | 100 |  8,211.9 ns |  68.39 ns |  53.40 ns |\n|         GetMonthIndex_If | 100 | 26,460.3 ns | 513.94 ns | 990.18 ns |\n| GetMonthIndex_Dictionary | 100 | 17,662.1 ns | 286.67 ns | 254.13 ns |\n```\n\nAs you can above, the `GetMonthIndex_Switch` is the fastest,\n`GetMonthIndex_Dictionary` ranks on the second place,\nand `GetMonthIndex_If` is the slowest.\n\n> Mind that these are nanoseconds (!) it won't effect your application\nperformance very much.\n\nNow why is `switch` faster than `if`?\n\n\n\n## The switch statement distilled\n\nIn fact, the switch statement does not exist in C#.\nThere is a step in the compilation of C#,\nwhich rewrites switch statements to if-statements.\nThis step is called **lowering**.\nIt translates high-level language features to low-level language features.\n\n> You can [read more about it here](https://mattwarren.org/2017/05/25/Lowering-in-the-C-Compiler/).\nYou will also notice that this is very widely used.\n\n\nWith [sharplab.io](https://sharplab.io/) you can see the C#-code which is produced during lowering.\nWhen we paste our original `GetMonthIndexSwitch` in there,\nyou will see that this is rewritten into `if` statements.\n\n\n```csharp\nprivate int GetMonthIndexSwitch(string month)\n{\n    uint num = <PrivateImplementationDetails>.ComputeStringHash(month);\n    if (num <= 1118301483)\n    {\n        if (num <= 749839599)\n        {\n            if (num != 566134113)\n            {\n                if (num != 663571330)\n                {\n                    if (num == 749839599 && month == \"Sep\")\n                    {\n                        return 9;\n                    }\n                }\n                else if (month == \"Feb\")\n                {\n                    return 2;\n                }\n            }\n            else if (month == \"Okt\")\n            {\n                return 10;\n            }\n        }\n        else if (num != 1000858150)\n        {\n            if (num != 1046388392)\n            {\n                if (num == 1118301483 && month == \"Mar\")\n                {\n                    return 3;\n                }\n            }\n            else if (month == \"Dez\")\n            {\n                return 12;\n            }\n        }\n        else if (month == \"May\")\n        {\n            return 5;\n        }\n    }\n    else if (num <= 1190317742)\n    {\n        if (num != 1153511100)\n        {\n            if (num != 1187066338)\n            {\n                if (num == 1190317742 && month == \"Jan\")\n                {\n                    return 1;\n                }\n            }\n            else if (month == \"Jun\")\n            {\n                return 6;\n            }\n        }\n        else if (month == \"Jul\")\n        {\n            return 7;\n        }\n    }\n    else if (num != 2213879282u)\n    {\n        if (num != 2319303684u)\n        {\n            if (num == 2699988948u && month == \"Aug\")\n            {\n                return 8;\n            }\n        }\n        else if (month == \"Nov\")\n        {\n            return 11;\n        }\n    }\n    else if (month == \"Apr\")\n    {\n        return 4;\n    }\n    throw new ArgumentException();\n}\n```\n\nCompared to our solution with the if-statements,\nit produces the same output but works in a whole different way.\n\nInstead of going through all cases, it builds up a tree-like structure.\nThis is where the performance gain comes.\nIt's just faster when you look for a match in a tree-structure,\nthan to look for a match when iterating all possible cases.\nBelow you can see an example of a tree-structure.\n\n> The compiler only rewrites it into a tree-structure if there are enough possible cases.\nWhen there are less than seven cases, no tree-structure is built.\n\n![An example tree structure. This does not match the code generated during lowering seen above](./tree-structure.png)\n\n*An example tree structure. This does not match the code generated during lowering seen above*\n\n## Summary\n\n* Switch statements are rewritten by the compiler to if-statements.\nDue to the rewriting into a tree-structure, it gets faster the more cases are.\n* There are many other high-level language features\nwhich are rewritten during the lowering step in the compilation.\n* In this scenario with 12 cases, `if` is the slowest, the `dictionary` ranks second\nand the `switch` is the fastest.\nNevertheless, it probably won't affect your application's performance.\n\n","html":"<p>C# does support multiple control structures such as <code class=\"language-text\">if</code>, <code class=\"language-text\">else</code>, <code class=\"language-text\">switch</code>, <code class=\"language-text\">while</code>, <code class=\"language-text\">for</code> (and some more).\nWith a control structure you can split your code in multiple possible paths, based on a codition.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 361px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d992338ae4e1eacbad8125ac2958f5f1/39d76/control-structure.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 105.40540540540542%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAABv0lEQVQ4y52V2Y7CMAxF8//fxiMIntgpUNZSaGmBenQsOQqZUg0TyUrk5ca+dlon0WqaRvfD4SDH41GKopDr9Sq3203Pp9NJ9aFvuNwnwMvlIkmSyHQ6lTRNZT6fy3K5VF2e598Dns9nybJMBQB2LiE7bF8DUiIAtkMBJQPM/mfANse6rhWoy8cDmoE9Flvwtlgs3sDafNld122US1fLslSBP3RdVb1laOQjm81GuXo8HjIajVQoHR22sGFhpp7D5/PpjZytGWTFuKxWK20MPtjweb1e6sPuOayqSo0YJpOJApIJTugZ6lAMCB/WeDz2enSOm1GQPvMFMFkwzDhZlw0ACna7nfrga/PKGXE29TjRTUsfPcHxApgEWOy8pLBRDiAysTcLBQDBnQGGowEgnSeGznPx/X73VTgCreT9fu9LMbLjebNGIMQRY93WkuMuf7t+dTm8mVJsvkKBeDIhOLYRE1by9lIwwBvC2Rzhlxm0SmK/jy8lXBBthDNas9lMG0aW6NqenWYYP+7we7her3WcONM8stxut/7L0xbb+cUGYDAYSL/fl16vJ8PhUAce279+AfBDmQwu5duT7AL8AZHFaKHsGcEBAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"A general graphical representation of a control structure\"\n        title=\"A general graphical representation of a control structure\"\n        src=\"/static/d992338ae4e1eacbad8125ac2958f5f1/39d76/control-structure.png\"\n        srcset=\"/static/d992338ae4e1eacbad8125ac2958f5f1/12f09/control-structure.png 148w,\n/static/d992338ae4e1eacbad8125ac2958f5f1/e4a3f/control-structure.png 295w,\n/static/d992338ae4e1eacbad8125ac2958f5f1/39d76/control-structure.png 361w\"\n        sizes=\"(max-width: 361px) 100vw, 361px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><em>A general graphical representation of a control structure</em></p>\n<p>The <code class=\"language-text\">if</code> and <code class=\"language-text\">switch</code> statements are very well-known and adopted in most programming languages nowadays.\nThey are also often applied for the same use-case.</p>\n<h1>The experiment</h1>\n<p>Given a three-digit string of month names, like <code class=\"language-text\">Jan</code>, <code class=\"language-text\">Feb</code>, <code class=\"language-text\">Mar</code>, … we want to get the corresponding month number as integer.\nThe results would be: <code class=\"language-text\">Jan = 1</code>, <code class=\"language-text\">Feb = 2</code>, <code class=\"language-text\">Mar = 3</code> and so on.</p>\n<h3>The if-implementation</h3>\n<p>This is the baseline implementation with <code class=\"language-text\">if</code> and <code class=\"language-text\">return</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> <span class=\"token function\">GetMonthIndexIf</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> month<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>month <span class=\"token operator\">==</span> <span class=\"token string\">\"Jan\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>month <span class=\"token operator\">==</span> <span class=\"token string\">\"Feb\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>month <span class=\"token operator\">==</span> <span class=\"token string\">\"Mar\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// and so on</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>The switch-implementation</h3>\n<p>This is the equivalent implementation with a <code class=\"language-text\">switch</code> statement.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> <span class=\"token function\">GetMonthIndexSwitch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> month<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> month <span class=\"token keyword\">switch</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"Jan\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Feb\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Mar\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Apr\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"May\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Jun\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Jul\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Aug\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Sep\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Okt\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Nov\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">11</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Dez\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span>\n        _     <span class=\"token operator\">=></span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>The syntax used above is called a <strong>switch expression</strong>.\nThis is available since C# 8.0, see: <a href=\"https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/operators/switch-expression\">MSDN Docs</a></p>\n</blockquote>\n<h3>The Dictionary-implementation</h3>\n<p>For reference, I’ve also created an implementation based on a <code class=\"language-text\">Dictionary&lt;string, int></code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> <span class=\"token function\">GetMonthIndexDictionary</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> month<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// _monthsDict maps the month name to the index</span>\n    <span class=\"token keyword\">return</span> _monthsDict<span class=\"token punctuation\">[</span>month<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Benchmark setup</h2>\n<p>I’m using <code class=\"language-text\">BenchmarkDotNet</code> for running the benchmarks.\nFor every <code class=\"language-text\">GetMonthIndex*</code> method, all months from <code class=\"language-text\">Jan</code> to <code class=\"language-text\">Dez</code> are called <code class=\"language-text\">N</code> times,\nto cover every path of these methods.\nThe benchmark is executed three times, for <code class=\"language-text\">N=1, 10, 100</code>.</p>\n<h2>Benchmark results</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">BenchmarkDotNet</span><span class=\"token operator\">=</span>v0.13.1, <span class=\"token assign-left variable\">OS</span><span class=\"token operator\">=</span>Windows <span class=\"token number\">10.0</span>.19044.1645 <span class=\"token punctuation\">(</span>21H2<span class=\"token punctuation\">)</span>\nIntel Core i7-8650U CPU <span class=\"token number\">1</span>.90GHz <span class=\"token punctuation\">(</span>Kaby Lake R<span class=\"token punctuation\">)</span>, <span class=\"token number\">1</span> CPU, <span class=\"token number\">8</span> logical and <span class=\"token number\">4</span> physical cores\n.NET <span class=\"token assign-left variable\">SDK</span><span class=\"token operator\">=</span><span class=\"token number\">6.0</span>.104\n  <span class=\"token punctuation\">[</span>Host<span class=\"token punctuation\">]</span>     <span class=\"token builtin class-name\">:</span> .NET <span class=\"token number\">6.0</span>.4 <span class=\"token punctuation\">(</span><span class=\"token number\">6.0</span>.422.16404<span class=\"token punctuation\">)</span>, X64 RyuJIT\n  DefaultJob <span class=\"token builtin class-name\">:</span> .NET <span class=\"token number\">6.0</span>.4 <span class=\"token punctuation\">(</span><span class=\"token number\">6.0</span>.422.16404<span class=\"token punctuation\">)</span>, X64 RyuJIT\n\n\n<span class=\"token operator\">|</span>                   Method <span class=\"token operator\">|</span>   N <span class=\"token operator\">|</span>        Mean <span class=\"token operator\">|</span>     Error <span class=\"token operator\">|</span>    StdDev <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>------------------------- <span class=\"token operator\">|</span>---- <span class=\"token operator\">|</span>------------:<span class=\"token operator\">|</span>----------:<span class=\"token operator\">|</span>----------:<span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     GetMonthIndex_Switch <span class=\"token operator\">|</span>   <span class=\"token number\">1</span> <span class=\"token operator\">|</span>    <span class=\"token number\">173.7</span> ns <span class=\"token operator\">|</span>   <span class=\"token number\">0.77</span> ns <span class=\"token operator\">|</span>   <span class=\"token number\">0.72</span> ns <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>         GetMonthIndex_If <span class=\"token operator\">|</span>   <span class=\"token number\">1</span> <span class=\"token operator\">|</span>    <span class=\"token number\">485.6</span> ns <span class=\"token operator\">|</span>   <span class=\"token number\">3.13</span> ns <span class=\"token operator\">|</span>   <span class=\"token number\">2.78</span> ns <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> GetMonthIndex_Dictionary <span class=\"token operator\">|</span>   <span class=\"token number\">1</span> <span class=\"token operator\">|</span>    <span class=\"token number\">325.8</span> ns <span class=\"token operator\">|</span>   <span class=\"token number\">1.70</span> ns <span class=\"token operator\">|</span>   <span class=\"token number\">1.42</span> ns <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     GetMonthIndex_Switch <span class=\"token operator\">|</span>  <span class=\"token number\">10</span> <span class=\"token operator\">|</span>    <span class=\"token number\">960.9</span> ns <span class=\"token operator\">|</span>   <span class=\"token number\">5.56</span> ns <span class=\"token operator\">|</span>   <span class=\"token number\">5.20</span> ns <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>         GetMonthIndex_If <span class=\"token operator\">|</span>  <span class=\"token number\">10</span> <span class=\"token operator\">|</span>  <span class=\"token number\">2,528</span>.3 ns <span class=\"token operator\">|</span>  <span class=\"token number\">15.35</span> ns <span class=\"token operator\">|</span>  <span class=\"token number\">14.36</span> ns <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> GetMonthIndex_Dictionary <span class=\"token operator\">|</span>  <span class=\"token number\">10</span> <span class=\"token operator\">|</span>  <span class=\"token number\">1,793</span>.8 ns <span class=\"token operator\">|</span>  <span class=\"token number\">25.68</span> ns <span class=\"token operator\">|</span>  <span class=\"token number\">22.77</span> ns <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     GetMonthIndex_Switch <span class=\"token operator\">|</span> <span class=\"token number\">100</span> <span class=\"token operator\">|</span>  <span class=\"token number\">8,211</span>.9 ns <span class=\"token operator\">|</span>  <span class=\"token number\">68.39</span> ns <span class=\"token operator\">|</span>  <span class=\"token number\">53.40</span> ns <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>         GetMonthIndex_If <span class=\"token operator\">|</span> <span class=\"token number\">100</span> <span class=\"token operator\">|</span> <span class=\"token number\">26,460</span>.3 ns <span class=\"token operator\">|</span> <span class=\"token number\">513.94</span> ns <span class=\"token operator\">|</span> <span class=\"token number\">990.18</span> ns <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> GetMonthIndex_Dictionary <span class=\"token operator\">|</span> <span class=\"token number\">100</span> <span class=\"token operator\">|</span> <span class=\"token number\">17,662</span>.1 ns <span class=\"token operator\">|</span> <span class=\"token number\">286.67</span> ns <span class=\"token operator\">|</span> <span class=\"token number\">254.13</span> ns <span class=\"token operator\">|</span></code></pre></div>\n<p>As you can above, the <code class=\"language-text\">GetMonthIndex_Switch</code> is the fastest,\n<code class=\"language-text\">GetMonthIndex_Dictionary</code> ranks on the second place,\nand <code class=\"language-text\">GetMonthIndex_If</code> is the slowest.</p>\n<blockquote>\n<p>Mind that these are nanoseconds (!) it won’t effect your application\nperformance very much.</p>\n</blockquote>\n<p>Now why is <code class=\"language-text\">switch</code> faster than <code class=\"language-text\">if</code>?</p>\n<h2>The switch statement distilled</h2>\n<p>In fact, the switch statement does not exist in C#.\nThere is a step in the compilation of C#,\nwhich rewrites switch statements to if-statements.\nThis step is called <strong>lowering</strong>.\nIt translates high-level language features to low-level language features.</p>\n<blockquote>\n<p>You can <a href=\"https://mattwarren.org/2017/05/25/Lowering-in-the-C-Compiler/\">read more about it here</a>.\nYou will also notice that this is very widely used.</p>\n</blockquote>\n<p>With <a href=\"https://sharplab.io/\">sharplab.io</a> you can see the C#-code which is produced during lowering.\nWhen we paste our original <code class=\"language-text\">GetMonthIndexSwitch</code> in there,\nyou will see that this is rewritten into <code class=\"language-text\">if</code> statements.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> <span class=\"token function\">GetMonthIndexSwitch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> month<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">uint</span></span> num <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>PrivateImplementationDetails<span class=\"token operator\">></span><span class=\"token punctuation\">.</span><span class=\"token function\">ComputeStringHash</span><span class=\"token punctuation\">(</span>month<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">&lt;=</span> <span class=\"token number\">1118301483</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">&lt;=</span> <span class=\"token number\">749839599</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">!=</span> <span class=\"token number\">566134113</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">!=</span> <span class=\"token number\">663571330</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">==</span> <span class=\"token number\">749839599</span> <span class=\"token operator\">&amp;&amp;</span> month <span class=\"token operator\">==</span> <span class=\"token string\">\"Sep\"</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">return</span> <span class=\"token number\">9</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>month <span class=\"token operator\">==</span> <span class=\"token string\">\"Feb\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>month <span class=\"token operator\">==</span> <span class=\"token string\">\"Okt\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">!=</span> <span class=\"token number\">1000858150</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">!=</span> <span class=\"token number\">1046388392</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">==</span> <span class=\"token number\">1118301483</span> <span class=\"token operator\">&amp;&amp;</span> month <span class=\"token operator\">==</span> <span class=\"token string\">\"Mar\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>month <span class=\"token operator\">==</span> <span class=\"token string\">\"Dez\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token number\">12</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>month <span class=\"token operator\">==</span> <span class=\"token string\">\"May\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">&lt;=</span> <span class=\"token number\">1190317742</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">!=</span> <span class=\"token number\">1153511100</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">!=</span> <span class=\"token number\">1187066338</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">==</span> <span class=\"token number\">1190317742</span> <span class=\"token operator\">&amp;&amp;</span> month <span class=\"token operator\">==</span> <span class=\"token string\">\"Jan\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>month <span class=\"token operator\">==</span> <span class=\"token string\">\"Jun\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>month <span class=\"token operator\">==</span> <span class=\"token string\">\"Jul\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token number\">7</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">!=</span> <span class=\"token number\">2213879282u</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">!=</span> <span class=\"token number\">2319303684u</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">==</span> <span class=\"token number\">2699988948u</span> <span class=\"token operator\">&amp;&amp;</span> month <span class=\"token operator\">==</span> <span class=\"token string\">\"Aug\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>month <span class=\"token operator\">==</span> <span class=\"token string\">\"Nov\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token number\">11</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>month <span class=\"token operator\">==</span> <span class=\"token string\">\"Apr\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Compared to our solution with the if-statements,\nit produces the same output but works in a whole different way.</p>\n<p>Instead of going through all cases, it builds up a tree-like structure.\nThis is where the performance gain comes.\nIt’s just faster when you look for a match in a tree-structure,\nthan to look for a match when iterating all possible cases.\nBelow you can see an example of a tree-structure.</p>\n<blockquote>\n<p>The compiler only rewrites it into a tree-structure if there are enough possible cases.\nWhen there are less than seven cases, no tree-structure is built.</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 441px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7133c2e7aa66b095e1d221e4a22bb6bd/efc6e/tree-structure.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.97297297297297%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAABLElEQVQ4y32TCQqFMAxEe/9rCm6473s/rxCpsf5CCZJxMpmkxnrnui4Xt22zTdPYcRxd3Pf9kf93jE8mP0C0LIstisKRDcPwwvwlFJDEaZrsPM83Md8hXJBQqvrVabOqKruuqy3L0n37Cn2sVm10hbZtnTLxUizouu6lJqTYiEe0lSTJTabBYMiDA/M1KEM7tIZnaZoGySSShwxSFJ/n+VZIZbkQS5vaq+M4XB4BURQ5hQxM+2hkz0jiX8h8ATMoCoJnWHow3NtDWkGFrigRS2gTHLfv+5ffwSn7SSmAZxDoA6EsPVinMNQaZqMGG7Iss3mef+4hNsRx7LD8Y0ID8CdJ9J+etkTUMwtITahdCJkob5lW9FvWhGBRyjyChLIenLquH6uksRQEw0HpD59knKXpDPoIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"An example tree structure. This does not match the code generated during lowering seen above\"\n        title=\"An example tree structure. This does not match the code generated during lowering seen above\"\n        src=\"/static/7133c2e7aa66b095e1d221e4a22bb6bd/efc6e/tree-structure.png\"\n        srcset=\"/static/7133c2e7aa66b095e1d221e4a22bb6bd/12f09/tree-structure.png 148w,\n/static/7133c2e7aa66b095e1d221e4a22bb6bd/e4a3f/tree-structure.png 295w,\n/static/7133c2e7aa66b095e1d221e4a22bb6bd/efc6e/tree-structure.png 441w\"\n        sizes=\"(max-width: 441px) 100vw, 441px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><em>An example tree structure. This does not match the code generated during lowering seen above</em></p>\n<h2>Summary</h2>\n<ul>\n<li>Switch statements are rewritten by the compiler to if-statements.\nDue to the rewriting into a tree-structure, it gets faster the more cases are.</li>\n<li>There are many other high-level language features\nwhich are rewritten during the lowering step in the compilation.</li>\n<li>In this scenario with 12 cases, <code class=\"language-text\">if</code> is the slowest, the <code class=\"language-text\">dictionary</code> ranks second\nand the <code class=\"language-text\">switch</code> is the fastest.\nNevertheless, it probably won’t affect your application’s performance.</li>\n</ul>","timeToRead":5,"fields":{"slug":"/blog/2022/switch-is-faster-than-if/"},"frontmatter":{"title":"Switch is Faster than If (in C#)","date":"May 24, 2022","description":"Switch statements are faster because the switch statement is optimized before getting compiled. When there are enough cases, a tree-structure is built","image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAQX/xAAWAQEBAQAAAAAAAAAAAAAAAAACAAH/2gAMAwEAAhADEAAAAYL+ThTxBt//xAAZEAADAQEBAAAAAAAAAAAAAAABAhEAEiH/2gAIAQEAAQUCQndMoZzb4Gmu/8QAFxEBAQEBAAAAAAAAAAAAAAAAAQACEv/aAAgBAwEBPwE0l03/xAAXEQEBAQEAAAAAAAAAAAAAAAABAAIS/9oACAECAQE/AXI3Jf/EABkQAAIDAQAAAAAAAAAAAAAAAAABECExMv/aAAgBAQAGPwLWdM1xUf/EAB4QAAIBAwUAAAAAAAAAAAAAAAABESExQVFxgaGx/9oACAEBAAE/IZC6R+SVLlISyjYbkXJPVn//2gAMAwEAAgADAAAAEKvP/8QAFhEBAQEAAAAAAAAAAAAAAAAAADFh/9oACAEDAQE/EIDR/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAExYf/aAAgBAgEBPxCwhg//xAAcEAEBAAIDAQEAAAAAAAAAAAABEQBBMVFxIZH/2gAIAQEAAT8QaST6f3rEdTTbHzbrK8/pcDgQ3UuVOVzlVsL05//Z","aspectRatio":1.5037593984962405,"src":"/static/75b22f60031548b6a466e0a24519c8b0/2f1b1/denys-nevozhai-Zeu57mprpaI-unsplash.jpg","srcSet":"/static/75b22f60031548b6a466e0a24519c8b0/fd013/denys-nevozhai-Zeu57mprpaI-unsplash.jpg 200w,\n/static/75b22f60031548b6a466e0a24519c8b0/25252/denys-nevozhai-Zeu57mprpaI-unsplash.jpg 400w,\n/static/75b22f60031548b6a466e0a24519c8b0/2f1b1/denys-nevozhai-Zeu57mprpaI-unsplash.jpg 800w,\n/static/75b22f60031548b6a466e0a24519c8b0/0ff54/denys-nevozhai-Zeu57mprpaI-unsplash.jpg 1200w,\n/static/75b22f60031548b6a466e0a24519c8b0/06655/denys-nevozhai-Zeu57mprpaI-unsplash.jpg 1600w,\n/static/75b22f60031548b6a466e0a24519c8b0/097fa/denys-nevozhai-Zeu57mprpaI-unsplash.jpg 1920w","sizes":"(max-width: 800px) 100vw, 800px"}}}}}},"pageContext":{"slug":"/blog/2022/switch-is-faster-than-if/","previous":{"fields":{"slug":"/blog/2022/timescoped-registration-with-ms-di/"},"frontmatter":{"title":"A Time-Scoped Registration Mechanism for Microsoft .Extensions.DependencyInjection","categories":["programming"]}},"next":null}},"staticQueryHashes":["143701507","3649515864"]}