{"componentChunkName":"component---src-templates-blogs-post-js","path":"/blog/2022/boost-async-code-in-csharp/","result":{"data":{"site":{"siteMetadata":{"title":"David Kröll"}},"markdownRemark":{"id":"c90d6b68-1d18-51ef-8415-651c8d42d2db","excerpt":"Performance is something every developer cares about.\nEven if most of us care about it too early, sooner or later it will impact the user…","rawMarkdownBody":"\nPerformance is something every developer cares about.\nEven if most of us care about it too early, sooner or later it will impact the user experience if we do not improve performance.\nA very crucial part of performance is the latency a user is exposed to.\n\n## TL; DR:\n> Use `Task.WhenAll()` to execute tasks in parallel,\nif the following task does not depend on a return value of the previous one.\nThis will reduce latency dramatically - without having to optimize every single code-path (if even possible).\n\n## Example\n\nImagine a platform which provides profile pages for users.\nThis platform is able to connect to other social media platforms and load data from there.\nAn example profile page would look like this:\n\n![An example profile page from a squirrel](./squirrels_profile.png)\n\n*An example profile page from a squirrel*\n\nThere are different user profile infos printed.\nTo have the latest data, every time a user accesses this profile page, \nthe data is retrieved directly from the third party service.\n\nTo retrieve the data, a `ProfileLoader` class is used.\nThis class returns some dummy data after a specific, artificial delay.\nI'll omit the implementation of the details-methods in this post.\nThe full source code is available as GitHub Gist (see **Conclusion** below).\n\n```csharp\npublic class ProfileLoader\n{\n    public async Task<Profile> GetProfileDetailsAsync(string userName)\n    {\n        var profile = await GetProfileMetaData(userName);\n\n        profile.ProfilePicture = await GetProfilePicture(profile.UserId);\n        profile.InstagramDetails = await GetInstagramDetailsAsync(profile.InstagramId);\n        profile.GithubDetails = await GetGithubDetailsAsync(profile.GithubId);\n        profile.LinkedInDetails = await GetLinkedInDetailsAsync(profile.LinkedInId);\n\n        return profile;\n    }\n}\n```\n\nFor this example, I've created a console application which prints the profile details as JSON to the console,\nalong with how long it took to gather the data.\nThe elapsed time is measured with the `Stopwatch`.\n\n```csharp\npublic static async Task Main()\n{\n    var profileLoader = new ProfileLoader();\n\n    var sw = Stopwatch.StartNew();\n    \n    var profile = await profileLoader.GetProfileDetailsAsync(\"TheAwesomeSquirrel\");\n\n    Console.WriteLine($\"Profile details retrieved, took {sw.ElapsedMilliseconds}ms\");\n\n    Console.WriteLine(JsonSerializer.Serialize(profile, new JsonSerializerOptions\n    {\n        WriteIndented = true\n    }));\n\n    // Output: \n    // Profile details retrieved, took 1528ms\n    // ...\n}\n```\n\nAccording to the code above, the tasks are executed in an asynchronous manner, but still one after another.\nThe thread does not block (because it is async) but the execution is not parallel either.\n\n![Flowchart when using sequential execution](./flowchart_normal.png)\n\n*These are the steps executed one after another. The numbers on the x-axis are the artificial delays.*\n\nEvery `await` schedules a thread on the thread pool and waits for the result.\nAfter the method returns, the thread continues in the original method.\nIn the diagram above, you can see how the execution is done.\nEvery subsequent task does not start before the current one has completed.\n\nThis is the part which can be optimized easily with `Task.WhenAll()`.\nTask.WhenAll() allows us to start all tasks at the same time and\nwait until every single task has completed it's operation.\n\nNo task therefore delays the execution of another one.\n\n![Flowchart when using parallel execution with Task.WhenAll](./flowchart_fast.png)\n\n*These are the steps executed in parallel. The numbers on the x-axis are the artificial delays.*\n\n\nBelow is the new implementation of the `ProfileLoader`.\nAll the methods which are called in here to get the details **were not touched**.\n\n```csharp\npublic class ProfileLoader\n{   \n    public async Task<Profile> GetProfileDetailsFastAsync(string userName)\n    {\n        var profile = await GetProfileMetaData(userName);\n\n        var profilePictureTask = GetProfilePicture(profile.UserId);\n        var instagramDetailsTask = GetInstagramDetailsAsync(profile.InstagramId);\n        var githubDetailsTask = GetGithubDetailsAsync(profile.GithubId);\n        var linkedInDetailsTask = GetLinkedInDetailsAsync(profile.LinkedInId);\n\n        // start all tasks in parallel and wait until all are completed\n        await Task.WhenAll(profilePictureTask, instagramDetailsTask, githubDetailsTask, linkedInDetailsTask);\n\n        // await does not wait here, because tasks are already completed\n        profile.ProfilePicture = await profilePictureTask;\n        profile.InstagramDetails = await instagramDetailsTask;\n        profile.GithubDetails = await githubDetailsTask;\n        profile.LinkedInDetails = await linkedInDetailsTask;\n        \n        return profile;\n    }\n}\n\npublic static async Task Main()\n{\n    var profileLoader = new ProfileLoader();\n\n    var sw = Stopwatch.StartNew();\n       \n    var profileFast = await profileLoader.GetProfileDetailsFastAsync(\"TheAwesomeSquirrel\");\n\n    System.Console.WriteLine($\"Profile details retrieved, took {sw.ElapsedMilliseconds}ms\");\n\n    System.Console.WriteLine(JsonSerializer.Serialize(profileFast, new JsonSerializerOptions\n    {\n        WriteIndented = true\n    }));\n\n    // Output: \n    // Profile details retrieved, took 833ms\n    // ...\n}\n```\n\nAs you can see, the total execution is much faster now.\nStill every method has it's artificial delay, but since it's\nnow running in parallel, the total delay is much lower. \nAlso the overhead compared to when awaiting every task one after another is lower.\nBefore, the overhead (in addition to the artifical delays) was 78ms, now it is reduced to 33ms.\n\n\n## Conclusion\n\nOnly by optimizing how tasks are awaited, a lot of performance can be gained.\nThis is possible when method return values do not depend upon another one.\nAlso the overhead in awaiting the tasks is reduced.\n\n> Note: The `WhenAll()` also has an overload which returns the result:\n`WhenAll<TResult>(IEnumerable<Task<TResult>>)`.\nWhen all of your provided tasks have the same result type, an\narray of results is returned, which you can then use to combine\nall of them together.\n\nHave you ever used `Task.WhenAll()` to improve the performance of your app?\n\nYou can view the whole source code on my [GitHub](\nhttps://github.com/davidkroell/davidkroell.com/tree/main/content/blogposts/2022/boost-async-code-in-csharp/src/).\n\n","html":"<p>Performance is something every developer cares about.\nEven if most of us care about it too early, sooner or later it will impact the user experience if we do not improve performance.\nA very crucial part of performance is the latency a user is exposed to.</p>\n<h2>TL; DR:</h2>\n<blockquote>\n<p>Use <code class=\"language-text\">Task.WhenAll()</code> to execute tasks in parallel,\nif the following task does not depend on a return value of the previous one.\nThis will reduce latency dramatically - without having to optimize every single code-path (if even possible).</p>\n</blockquote>\n<h2>Example</h2>\n<p>Imagine a platform which provides profile pages for users.\nThis platform is able to connect to other social media platforms and load data from there.\nAn example profile page would look like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 414px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c92b866e55038a9ddf09fa900ed9a9f0/b910a/squirrels_profile.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.75675675675676%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAB90lEQVQoz41Sy4oTURDtpbgTd4IrcaN7V4pLdZqZjY9x0GXIDwwiLpIQkhjIJgtB0PmIhBAFk0AYcMCNI5NsDLgx6c476Tw6r+50HW8V6WEYRrGguu6trntunVNXg7Kv347o5fNHCO4+xMGHd5zCZDLBarUSX6/XcF0XjuOIz+dziZxbLpeyVkb80ayx5b14/QxvXz2lcPABXbl2GT8qx6icVJDNZpHL5ZDP51EqlVAoFFAulyWfyWT8PBWLRQEjIk/73TRpe/cODvbv05vgPVy9fgmfv3ySLnu9HobDIQaDgcRut4t+v4/xeAzLsqQzz/OYgQ9I2mLl4OP7FPae3MLdndvYCzyGPZ/J4Xa7jU6nI8C8bzQaME1TQKfTKc6awpKo+T9+/jrB0fdD2LMZ/tcYxHd/r3H7i8UCa9c7LZwpUHYWn0XnaNu25HhI50H8tXSoAIlpVKtVMowGHNcRikzVMAyhx3umz5RZy/NAtFmIhqPRyGs2m6SKOUkssLqAlGbUarVIPR+JCpzq9TopQNqcvcg8jemqbqhWq5HSk9TUSHVzCsiuaqSaL9tM9EI0oawomfxAmRZHNn4OfBEPjLU7q9G/TGF0tVgsdiOVSu2k0+mteDyuRyIRPZFI6MlkUld58Wg0qodCIT0cDv/Nt1TNdiAQuPkHtYoE4fFS2UQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"An example profile page from a squirrel\"\n        title=\"An example profile page from a squirrel\"\n        src=\"/static/c92b866e55038a9ddf09fa900ed9a9f0/b910a/squirrels_profile.png\"\n        srcset=\"/static/c92b866e55038a9ddf09fa900ed9a9f0/12f09/squirrels_profile.png 148w,\n/static/c92b866e55038a9ddf09fa900ed9a9f0/e4a3f/squirrels_profile.png 295w,\n/static/c92b866e55038a9ddf09fa900ed9a9f0/b910a/squirrels_profile.png 414w\"\n        sizes=\"(max-width: 414px) 100vw, 414px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><em>An example profile page from a squirrel</em></p>\n<p>There are different user profile infos printed.\nTo have the latest data, every time a user accesses this profile page,\nthe data is retrieved directly from the third party service.</p>\n<p>To retrieve the data, a <code class=\"language-text\">ProfileLoader</code> class is used.\nThis class returns some dummy data after a specific, artificial delay.\nI’ll omit the implementation of the details-methods in this post.\nThe full source code is available as GitHub Gist (see <strong>Conclusion</strong> below).</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ProfileLoader</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>Profile<span class=\"token punctuation\">></span></span> <span class=\"token function\">GetProfileDetailsAsync</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> userName<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> profile <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">GetProfileMetaData</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        profile<span class=\"token punctuation\">.</span>ProfilePicture <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">GetProfilePicture</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">.</span>UserId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        profile<span class=\"token punctuation\">.</span>InstagramDetails <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">GetInstagramDetailsAsync</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">.</span>InstagramId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        profile<span class=\"token punctuation\">.</span>GithubDetails <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">GetGithubDetailsAsync</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">.</span>GithubId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        profile<span class=\"token punctuation\">.</span>LinkedInDetails <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">GetLinkedInDetailsAsync</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">.</span>LinkedInId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> profile<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>For this example, I’ve created a console application which prints the profile details as JSON to the console,\nalong with how long it took to gather the data.\nThe elapsed time is measured with the <code class=\"language-text\">Stopwatch</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> profileLoader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ProfileLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> sw <span class=\"token operator\">=</span> Stopwatch<span class=\"token punctuation\">.</span><span class=\"token function\">StartNew</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> profile <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> profileLoader<span class=\"token punctuation\">.</span><span class=\"token function\">GetProfileDetailsAsync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TheAwesomeSquirrel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Profile details retrieved, took </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">sw<span class=\"token punctuation\">.</span>ElapsedMilliseconds</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">ms\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span>JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">JsonSerializerOptions</span>\n    <span class=\"token punctuation\">{</span>\n        WriteIndented <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Output: </span>\n    <span class=\"token comment\">// Profile details retrieved, took 1528ms</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>According to the code above, the tasks are executed in an asynchronous manner, but still one after another.\nThe thread does not block (because it is async) but the execution is not parallel either.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/81f02e971dd88d229583687d094a2526/18872/flowchart_normal.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABDUlEQVQoz4WT2a6FMAgA/f9fNNEX933flZMhqen1LJekAWkZKFRnmiZBjuOQ67rEFvONtu1f4oRhKJ7nSRAEd6CB28sG/4I6dV1LVVWSZZmkaSplWQq+p3yDvwGXZVGj6zoFxnEsURRJ27a6mqZRbQc/q7fhjunhvu+qt23TKgEnSaJwKjYB5twn4cwNBHSe5z0gAqme6gC7riu+72sy9lmcR9uxfyr8VsW6rtoSrg+cRNj0ve97gQFUgcMwqDHPszqBEoBtqmAPPz6AQIqiUJt2kAyOXpkr8WTIiNPYJpgqqCDPcx0aNgmI48nxPY6jxnBGpwzZ9ABt2/YU7T2z/zaUT3/Gf/bzDZoXgbwA4l5cTW5qj2QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Flowchart when using sequential execution\"\n        title=\"Flowchart when using sequential execution\"\n        src=\"/static/81f02e971dd88d229583687d094a2526/fcda8/flowchart_normal.png\"\n        srcset=\"/static/81f02e971dd88d229583687d094a2526/12f09/flowchart_normal.png 148w,\n/static/81f02e971dd88d229583687d094a2526/e4a3f/flowchart_normal.png 295w,\n/static/81f02e971dd88d229583687d094a2526/fcda8/flowchart_normal.png 590w,\n/static/81f02e971dd88d229583687d094a2526/18872/flowchart_normal.png 608w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><em>These are the steps executed one after another. The numbers on the x-axis are the artificial delays.</em></p>\n<p>Every <code class=\"language-text\">await</code> schedules a thread on the thread pool and waits for the result.\nAfter the method returns, the thread continues in the original method.\nIn the diagram above, you can see how the execution is done.\nEvery subsequent task does not start before the current one has completed.</p>\n<p>This is the part which can be optimized easily with <code class=\"language-text\">Task.WhenAll()</code>.\nTask.WhenAll() allows us to start all tasks at the same time and\nwait until every single task has completed it’s operation.</p>\n<p>No task therefore delays the execution of another one.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cbe17b4edfd2489037a4fda1b5239c25/18872/flowchart_fast.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAA3klEQVQoz5WT6QqEMAyEff+nVPG+631UZ3eyVMQFqQPBtD++ziTo4CutNbZtw3EcZ1H33kaO67qI41iAV10BtjABVlWFLMuQpinYF0Vxwul83/d3DsdxFJDneYiiSKptWwEQTOgr4DzPMC7zPEcYhjKCdV0F9ho4TROapoHv+0iSRIqPMOo9sk0JsK5rBEGAsiwlctd14Cj6vv9b1pMEyMYsgzHpkHBCCeSdrUOJTBCXwNgsAumYQH4Jpdunuu7BUUrJhXmB52VZpDeLsRFnPQzDL/L9rzDioujaJrLRB/dXXs8AW/NTAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Flowchart when using parallel execution with Task.WhenAll\"\n        title=\"Flowchart when using parallel execution with Task.WhenAll\"\n        src=\"/static/cbe17b4edfd2489037a4fda1b5239c25/fcda8/flowchart_fast.png\"\n        srcset=\"/static/cbe17b4edfd2489037a4fda1b5239c25/12f09/flowchart_fast.png 148w,\n/static/cbe17b4edfd2489037a4fda1b5239c25/e4a3f/flowchart_fast.png 295w,\n/static/cbe17b4edfd2489037a4fda1b5239c25/fcda8/flowchart_fast.png 590w,\n/static/cbe17b4edfd2489037a4fda1b5239c25/18872/flowchart_fast.png 608w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><em>These are the steps executed in parallel. The numbers on the x-axis are the artificial delays.</em></p>\n<p>Below is the new implementation of the <code class=\"language-text\">ProfileLoader</code>.\nAll the methods which are called in here to get the details <strong>were not touched</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ProfileLoader</span>\n<span class=\"token punctuation\">{</span>   \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>Profile<span class=\"token punctuation\">></span></span> <span class=\"token function\">GetProfileDetailsFastAsync</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> userName<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> profile <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">GetProfileMetaData</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> profilePictureTask <span class=\"token operator\">=</span> <span class=\"token function\">GetProfilePicture</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">.</span>UserId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> instagramDetailsTask <span class=\"token operator\">=</span> <span class=\"token function\">GetInstagramDetailsAsync</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">.</span>InstagramId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> githubDetailsTask <span class=\"token operator\">=</span> <span class=\"token function\">GetGithubDetailsAsync</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">.</span>GithubId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> linkedInDetailsTask <span class=\"token operator\">=</span> <span class=\"token function\">GetLinkedInDetailsAsync</span><span class=\"token punctuation\">(</span>profile<span class=\"token punctuation\">.</span>LinkedInId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// start all tasks in parallel and wait until all are completed</span>\n        <span class=\"token keyword\">await</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">WhenAll</span><span class=\"token punctuation\">(</span>profilePictureTask<span class=\"token punctuation\">,</span> instagramDetailsTask<span class=\"token punctuation\">,</span> githubDetailsTask<span class=\"token punctuation\">,</span> linkedInDetailsTask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// await does not wait here, because tasks are already completed</span>\n        profile<span class=\"token punctuation\">.</span>ProfilePicture <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> profilePictureTask<span class=\"token punctuation\">;</span>\n        profile<span class=\"token punctuation\">.</span>InstagramDetails <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> instagramDetailsTask<span class=\"token punctuation\">;</span>\n        profile<span class=\"token punctuation\">.</span>GithubDetails <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> githubDetailsTask<span class=\"token punctuation\">;</span>\n        profile<span class=\"token punctuation\">.</span>LinkedInDetails <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> linkedInDetailsTask<span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">return</span> profile<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> profileLoader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ProfileLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> sw <span class=\"token operator\">=</span> Stopwatch<span class=\"token punctuation\">.</span><span class=\"token function\">StartNew</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       \n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> profileFast <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> profileLoader<span class=\"token punctuation\">.</span><span class=\"token function\">GetProfileDetailsFastAsync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TheAwesomeSquirrel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    System<span class=\"token punctuation\">.</span>Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Profile details retrieved, took </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">sw<span class=\"token punctuation\">.</span>ElapsedMilliseconds</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">ms\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    System<span class=\"token punctuation\">.</span>Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span>JsonSerializer<span class=\"token punctuation\">.</span><span class=\"token function\">Serialize</span><span class=\"token punctuation\">(</span>profileFast<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">JsonSerializerOptions</span>\n    <span class=\"token punctuation\">{</span>\n        WriteIndented <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Output: </span>\n    <span class=\"token comment\">// Profile details retrieved, took 833ms</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As you can see, the total execution is much faster now.\nStill every method has it’s artificial delay, but since it’s\nnow running in parallel, the total delay is much lower.\nAlso the overhead compared to when awaiting every task one after another is lower.\nBefore, the overhead (in addition to the artifical delays) was 78ms, now it is reduced to 33ms.</p>\n<h2>Conclusion</h2>\n<p>Only by optimizing how tasks are awaited, a lot of performance can be gained.\nThis is possible when method return values do not depend upon another one.\nAlso the overhead in awaiting the tasks is reduced.</p>\n<blockquote>\n<p>Note: The <code class=\"language-text\">WhenAll()</code> also has an overload which returns the result:\n<code class=\"language-text\">WhenAll&lt;TResult>(IEnumerable&lt;Task&lt;TResult>>)</code>.\nWhen all of your provided tasks have the same result type, an\narray of results is returned, which you can then use to combine\nall of them together.</p>\n</blockquote>\n<p>Have you ever used <code class=\"language-text\">Task.WhenAll()</code> to improve the performance of your app?</p>\n<p>You can view the whole source code on my <a href=\"https://github.com/davidkroell/davidkroell.com/tree/main/content/blogposts/2022/boost-async-code-in-csharp/src/\">GitHub</a>.</p>","timeToRead":4,"fields":{"slug":"/blog/2022/boost-async-code-in-csharp/"},"frontmatter":{"title":"A Simple Trick to Boost Performance of Async Code in C#","date":"February 08, 2022","description":"An introduction to Task.WhenAll() for C# Task Asynchronous Programming and how to use it properly in your applications to boost performance and reduce latency","image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAEEBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAXPVEMzg/8QAHBAAAQMFAAAAAAAAAAAAAAAAAgABAxEhIjEy/9oACAEBAAEFAjKhDNZ5mZHzNiO1/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAHRAAAgIBBQAAAAAAAAAAAAAAAAERIRASIjEyYf/aAAgBAQAGPwJKfSLerhnRjNqisf/EABwQAQACAwADAAAAAAAAAAAAAAEAETFBUWFxgf/aAAgBAQABPyFdTLJyYWx1wiFLeVJuAibjDoOFe6lGFn2f/9oADAMBAAIAAwAAABCwz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EAB0QAQACAgIDAAAAAAAAAAAAAAERIQBhMXFRgaH/2gAIAQEAAT8QjSBnoTSW2nGVEGU14VGd5QOUSSeWq6xQwKIHB3hQIbaIMhPr7ihYYxFp3n//2Q==","aspectRatio":1.5037593984962405,"src":"/static/9fb5043ac0e30ec7b56659521cf4f6cd/2f1b1/braden-collum-ttbCwN_mWic-unsplash.jpg","srcSet":"/static/9fb5043ac0e30ec7b56659521cf4f6cd/fd013/braden-collum-ttbCwN_mWic-unsplash.jpg 200w,\n/static/9fb5043ac0e30ec7b56659521cf4f6cd/25252/braden-collum-ttbCwN_mWic-unsplash.jpg 400w,\n/static/9fb5043ac0e30ec7b56659521cf4f6cd/2f1b1/braden-collum-ttbCwN_mWic-unsplash.jpg 800w,\n/static/9fb5043ac0e30ec7b56659521cf4f6cd/0ff54/braden-collum-ttbCwN_mWic-unsplash.jpg 1200w,\n/static/9fb5043ac0e30ec7b56659521cf4f6cd/06655/braden-collum-ttbCwN_mWic-unsplash.jpg 1600w,\n/static/9fb5043ac0e30ec7b56659521cf4f6cd/097fa/braden-collum-ttbCwN_mWic-unsplash.jpg 1920w","sizes":"(max-width: 800px) 100vw, 800px"}}}}}},"pageContext":{"slug":"/blog/2022/boost-async-code-in-csharp/","previous":{"fields":{"slug":"/blog/2021/homemade-di-the-hows-and-whys-of-dependency-injection/"},"frontmatter":{"title":"Homemade DI: The How's and Why's of Dependency Injection (in dotnet)","categories":["programming"]}},"next":{"fields":{"slug":"/blog/2022/dont-use-tolower-to-compare-strings/"},"frontmatter":{"title":"Don't use String.ToLower() in C# when comparing strings","categories":["programming"]}}}},"staticQueryHashes":["143701507","3649515864"]}