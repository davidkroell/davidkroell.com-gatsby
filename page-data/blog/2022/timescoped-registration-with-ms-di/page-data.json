{"componentChunkName":"component---src-templates-blogs-post-js","path":"/blog/2022/timescoped-registration-with-ms-di/","result":{"data":{"site":{"siteMetadata":{"title":"David Kröll"}},"markdownRemark":{"id":"bbace732-f5c9-5d62-a0a8-4ece9d4858c5","excerpt":"The Microsoft Dependency Injection (DI) container provides three different types of registrations. Transient Scoped Singleton A…","rawMarkdownBody":"\n\nThe Microsoft Dependency Injection (DI) container provides three different types of registrations.\n\n* Transient\n* Scoped\n* Singleton\n\nA `Transient` registration will always create a new instance of a service when requested.\nWhen registered as `Scoped`, there will be a single instance within a scope.\nA scope can be anything and is created via the [`IServiceProvider.CreateScope()`](https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.serviceproviderserviceextensions.createscope?view=dotnet-plat-ext-6.0)\nextension method.\nFor example, in ASP.NET every HTTP request has it's own scope.\nThe last type is the `Singleton` (a GoF design pattern), this resolves always the same instance, as the name suggests.\n\n\nThese days I wanted to have a DI registration which will be time-scoped.\nAs such, it will return a new instance, if the time in which it is valid runs out.\nYou can think of it like a *best-before date*.\n\nThe reference time should be the time, when it is accessed (created) first.\n\n![](./timescoped.png)\n\n*A diagram on how a resolve of a service should work and when there are fresh instances created*\n\n\n## Usage\n\nInstall the package `DavidKroell.TimeScoped` into your projects - it is available\nfrom [NuGet.org](https://www.nuget.org/packages/DavidKroell.TimeScoped/).\n\nWith `AddTimeScoped<TSerice>` you can add a time-scoped service to the DI container.\nYou can then resolve the time-scoped service as a generic interface: `ITimeScoped<DummyService>`\nThis interface has a single property - `Instance` - which will be your real service.\n\n```cs\nvar sc = new ServiceCollection();\n\nsc.AddTimeScoped<DummyService>(TimeSpan.FromSeconds(3));\n\nvar provider = sc.BuildServiceProvider();\n\nvar timeScopedService = provider.GetRequiredService<ITimeScoped<DummyService>>();\n\nvar instance1 = timeScopedService.Instance;\n\nawait Task.Delay(5000);\n\n// should return a new instance, because 3 seconds are over\nvar instance2 = timeScopedService.Instance;\n\nAssert.AreNotSame(instance1, instance2);\n```\n\n> Never store an instance of your real service in an variable!\nYou should always access it within the wrapper class.\n\n\n## Implementation\n\nThe implementation of this is pretty simple.\nThe main logic is all within the `Instance` getter method.\n\n\n```cs\ninternal class TimeScopedProvider<TService> : ITimeScoped<TService> where TService : class\n{\n    private readonly IServiceProvider _provider;\n    private readonly TimeSpan _validTimeSpan;\n    private DateTime? _validUntil;\n    private TService? _instance;\n    public TService Instance => GetInstance();\n\n    public TimeScopedProvider(IServiceProvider provider, TimeSpan validTimeSpan)\n    {\n        _provider = provider;\n        _validTimeSpan = validTimeSpan;\n    }\n\n    private TService GetInstance()\n    {\n        if (_validUntil == null || _validUntil < DateTime.Now)\n        {\n            lock (this)\n            {\n                CleanupOldInstance();\n\n                _instance = (TService) _provider.GetService(typeof(TService))!;\n\n                _validUntil = DateTime.Now.Add(_validTimeSpan);\n            }\n        }\n\n        return _instance!;\n    }\n\n    private void CleanupOldInstance()\n    {\n        if (_instance is IDisposable disposable)\n        {\n            disposable.Dispose();\n        }\n\n        _instance = null;\n    }\n}\n```\n\n## Summary\n\nYou can use this implementation when you want a new instance from time to time,\nbut not for every access.\nI've once used it for a simple cache implementation.\n\n","html":"<p>The Microsoft Dependency Injection (DI) container provides three different types of registrations.</p>\n<ul>\n<li>Transient</li>\n<li>Scoped</li>\n<li>Singleton</li>\n</ul>\n<p>A <code class=\"language-text\">Transient</code> registration will always create a new instance of a service when requested.\nWhen registered as <code class=\"language-text\">Scoped</code>, there will be a single instance within a scope.\nA scope can be anything and is created via the <a href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.serviceproviderserviceextensions.createscope?view=dotnet-plat-ext-6.0\"><code class=\"language-text\">IServiceProvider.CreateScope()</code></a>\nextension method.\nFor example, in ASP.NET every HTTP request has it’s own scope.\nThe last type is the <code class=\"language-text\">Singleton</code> (a GoF design pattern), this resolves always the same instance, as the name suggests.</p>\n<p>These days I wanted to have a DI registration which will be time-scoped.\nAs such, it will return a new instance, if the time in which it is valid runs out.\nYou can think of it like a <em>best-before date</em>.</p>\n<p>The reference time should be the time, when it is accessed (created) first.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 522px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cc6a499c9d654999ea5593580b32735b/29492/timescoped.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.621621621621614%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABtElEQVQoz32SW0/bQBCF8/9/S6l6eaJSW1pEIQQSASEtBGI78iWOd23Hd8dxPnYdJdA+dKTZXc2cOTt7dnpt27Jer9Gmz2EqSeuEbJ0S5ZKsTtlut12+rGrirCGvIVclcd5Qrdsut8f03hI2m4aJN+b88RdfBsdczvo8i6cDOEoqJnbN2a3N6cjibl4TJM3/CR+XD1wZA76NvjKaD7Fi4wCO04qp39KfLDi/s/njbQiz1w61d4RNs7ul3bbMHQsvcFlID8s1WUqfvaVZjmUv8EWs4iuFXapYwVvrCKuqYrPZdMRRGCGFJJQhnutRFmWX015VJSJYImWgMIE6+9S1rt29UnP1NDBJEsqyJMszTDHj+uGKy/EFo+kQJ7IpikJ5rjQsmNorhhOL63uT32ZIlNZUZdFxRFFEb/+7exs893n/44iPpx84OnnHxB0fcoVS5ueNy6fvN3w+ueX4YoZIX2vjOKanF82sBdVdOoGNI2zmvsXMeUKmYjcyqgshI0xHKn0z/DBjERaU9T9jYxgGlmV1ASGE0kWoJ1TEUax0CinystPHdV1M08A0ZiSr+K+P2JPp/QU8MqvSeeCHEgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"timescoped\"\n        title=\"timescoped\"\n        src=\"/static/cc6a499c9d654999ea5593580b32735b/29492/timescoped.png\"\n        srcset=\"/static/cc6a499c9d654999ea5593580b32735b/12f09/timescoped.png 148w,\n/static/cc6a499c9d654999ea5593580b32735b/e4a3f/timescoped.png 295w,\n/static/cc6a499c9d654999ea5593580b32735b/29492/timescoped.png 522w\"\n        sizes=\"(max-width: 522px) 100vw, 522px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><em>A diagram on how a resolve of a service should work and when there are fresh instances created</em></p>\n<h2>Usage</h2>\n<p>Install the package <code class=\"language-text\">DavidKroell.TimeScoped</code> into your projects - it is available\nfrom <a href=\"https://www.nuget.org/packages/DavidKroell.TimeScoped/\">NuGet.org</a>.</p>\n<p>With <code class=\"language-text\">AddTimeScoped&lt;TSerice></code> you can add a time-scoped service to the DI container.\nYou can then resolve the time-scoped service as a generic interface: <code class=\"language-text\">ITimeScoped&lt;DummyService></code>\nThis interface has a single property - <code class=\"language-text\">Instance</code> - which will be your real service.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> sc <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ServiceCollection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nsc<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddTimeScoped</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>DummyService<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>TimeSpan<span class=\"token punctuation\">.</span><span class=\"token function\">FromSeconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> provider <span class=\"token operator\">=</span> sc<span class=\"token punctuation\">.</span><span class=\"token function\">BuildServiceProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> timeScopedService <span class=\"token operator\">=</span> provider<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetRequiredService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ITimeScoped<span class=\"token punctuation\">&lt;</span>DummyService<span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> instance1 <span class=\"token operator\">=</span> timeScopedService<span class=\"token punctuation\">.</span>Instance<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">await</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// should return a new instance, because 3 seconds are over</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> instance2 <span class=\"token operator\">=</span> timeScopedService<span class=\"token punctuation\">.</span>Instance<span class=\"token punctuation\">;</span>\n\nAssert<span class=\"token punctuation\">.</span><span class=\"token function\">AreNotSame</span><span class=\"token punctuation\">(</span>instance1<span class=\"token punctuation\">,</span> instance2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>Never store an instance of your real service in an variable!\nYou should always access it within the wrapper class.</p>\n</blockquote>\n<h2>Implementation</h2>\n<p>The implementation of this is pretty simple.\nThe main logic is all within the <code class=\"language-text\">Instance</code> getter method.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TimeScopedProvider<span class=\"token punctuation\">&lt;</span>TService<span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">ITimeScoped<span class=\"token punctuation\">&lt;</span>TService<span class=\"token punctuation\">></span></span></span> <span class=\"token keyword\">where</span> <span class=\"token class-name\">TService</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token keyword\">class</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">IServiceProvider</span> _provider<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">TimeSpan</span> _validTimeSpan<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">DateTime<span class=\"token punctuation\">?</span></span> _validUntil<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">TService<span class=\"token punctuation\">?</span></span> _instance<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">TService</span> Instance <span class=\"token operator\">=></span> <span class=\"token function\">GetInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">TimeScopedProvider</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IServiceProvider</span> provider<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeSpan</span> validTimeSpan<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _provider <span class=\"token operator\">=</span> provider<span class=\"token punctuation\">;</span>\n        _validTimeSpan <span class=\"token operator\">=</span> validTimeSpan<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\">TService</span> <span class=\"token function\">GetInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_validUntil <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> _validUntil <span class=\"token operator\">&lt;</span> DateTime<span class=\"token punctuation\">.</span>Now<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">lock</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">CleanupOldInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                _instance <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>TService<span class=\"token punctuation\">)</span> _provider<span class=\"token punctuation\">.</span><span class=\"token function\">GetService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">TService</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span><span class=\"token punctuation\">;</span>\n\n                _validUntil <span class=\"token operator\">=</span> DateTime<span class=\"token punctuation\">.</span>Now<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>_validTimeSpan<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> _instance<span class=\"token operator\">!</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">CleanupOldInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_instance <span class=\"token keyword\">is</span> <span class=\"token class-name\">IDisposable</span> disposable<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            disposable<span class=\"token punctuation\">.</span><span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        _instance <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Summary</h2>\n<p>You can use this implementation when you want a new instance from time to time,\nbut not for every access.\nI’ve once used it for a simple cache implementation.</p>","timeToRead":2,"fields":{"slug":"/blog/2022/timescoped-registration-with-ms-di/"},"frontmatter":{"title":"A Time-Scoped Registration Mechanism for Microsoft .Extensions.DependencyInjection","date":"April 18, 2022","description":"A Mechanism to make a time-scoped registration which is just bound to a timeframe","image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHBpNhAE//EABoQAAICAwAAAAAAAAAAAAAAAAABAiEQERL/2gAIAQEAAQUCVjjQno6eP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABcQAAMBAAAAAAAAAAAAAAAAAAABESD/2gAIAQEABj8CKs//xAAZEAEBAAMBAAAAAAAAAAAAAAABEQAQMWH/2gAIAQEAAT8hFTPES6RU7ignL2a//9oADAMBAAIAAwAAABDgP//EABURAQEAAAAAAAAAAAAAAAAAABAh/9oACAEDAQE/EIf/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAgEBPxBGf//EABwQAAIBBQEAAAAAAAAAAAAAAAERcQAQITFBgf/aAAgBAQABPxAoQflDGYUMwdxqLAZ0FY0BwJzb/9k=","aspectRatio":1.5037593984962405,"src":"/static/154cf74670f63ac909974ff36fbe99aa/2f1b1/thomas-bormans-JsTmUnHdVYQ-unsplash.jpg","srcSet":"/static/154cf74670f63ac909974ff36fbe99aa/fd013/thomas-bormans-JsTmUnHdVYQ-unsplash.jpg 200w,\n/static/154cf74670f63ac909974ff36fbe99aa/25252/thomas-bormans-JsTmUnHdVYQ-unsplash.jpg 400w,\n/static/154cf74670f63ac909974ff36fbe99aa/2f1b1/thomas-bormans-JsTmUnHdVYQ-unsplash.jpg 800w,\n/static/154cf74670f63ac909974ff36fbe99aa/0ff54/thomas-bormans-JsTmUnHdVYQ-unsplash.jpg 1200w,\n/static/154cf74670f63ac909974ff36fbe99aa/06655/thomas-bormans-JsTmUnHdVYQ-unsplash.jpg 1600w,\n/static/154cf74670f63ac909974ff36fbe99aa/097fa/thomas-bormans-JsTmUnHdVYQ-unsplash.jpg 1920w","sizes":"(max-width: 800px) 100vw, 800px"}}}}}},"pageContext":{"slug":"/blog/2022/timescoped-registration-with-ms-di/","previous":{"fields":{"slug":"/blog/2022/dont-use-tolower-to-compare-strings/"},"frontmatter":{"title":"Don't use String.ToLower() in C# when comparing strings","categories":["programming"]}},"next":{"fields":{"slug":"/blog/2022/switch-is-faster-than-if/"},"frontmatter":{"title":"Switch is Faster than If (in C#)","categories":["programming"]}}}},"staticQueryHashes":["143701507","3649515864"]}