{"componentChunkName":"component---src-templates-blogs-post-js","path":"/blog/2022/dont-use-tolower-to-compare-strings/","result":{"data":{"site":{"siteMetadata":{"title":"David Kröll"}},"markdownRemark":{"id":"6ffb25bf-7b9c-52f9-a132-73399c1aefd6","excerpt":"When comparing strings, often the casing should be ignored in the comparison.\nMost of the times, this is required because every user writes…","rawMarkdownBody":"\nWhen comparing strings, often the casing should be ignored in the comparison.\nMost of the times, this is required because every user writes text different.\nI do not really care when there is \"Apple\" or \"apple\" in a dataset.\nTo me, this is the same.\nOn the other side, \"A\" and \"a\" are different characters for computers.\n\nTo overcome this problem, a working and very wide-spread approach is to first lowercase (or uppercase)\nall letters and then compare them.\nMost of us done it, me too - but no longer.\nAlthough there is a drawback you should keep in mind when it comes to performance.\n\nI've created a litte benchmark program an I'll evaluate the results afterwards.\nFirst I'll explain the benchmark setup.\n\n\n## Benchmark setup\n\nI've evaluated three types of string equality comparison.\n\n1. Strings which are equal (except casing)\n1. Strings which are not equal, differing in the **last** character\n1. Strings which are not equal, differing in the **first** character\n\nThese three test-cases were applied to string with lengths of 10, 100 and 1000 characters\n\nMy benchmark code looks like the below code snippet, where `StringToCheck` and `VerifyString` are generated.\n\n```cs\n[Benchmark]\npublic void StringComparison_Equals()\n{\n    var result = StringToCheck.Equals(VerifyString, StringComparison.CurrentCultureIgnoreCase);\n}\n\n[Benchmark]\npublic void StringComparison_EqualityOperator()\n{\n    var result = StringToCheck.ToLower() == VerifyString.ToLower();\n}\n```\n\n## Benchmark results\n\nI've used [`BenchmarkDotNet`](https://github.com/dotnet/BenchmarkDotNet)\nto run my test and enable the `MemoryDiagnoser` to also anaylse memory usage/allocations.\n\n\n```\nBenchmarkDotNet=v0.13.1, OS=Windows 10.0.19044.1526 (21H2)\nIntel Core i7-8650U CPU 1.90GHz (Kaby Lake R), 1 CPU, 8 logical and 4 physical cores\n.NET SDK=6.0.101\n  [Host]     : .NET 6.0.1 (6.0.121.56705), X64 RyuJIT\n  DefaultJob : .NET 6.0.1 (6.0.121.56705), X64 RyuJIT\n\n\n|                                    Method | Length |        Mean |     Error |    StdDev |      Median |  Gen 0 | Allocated |\n|------------------------------------------ |------- |------------:|----------:|----------:|------------:|-------:|----------:|\n|                   StringComparison_Equals |     10 |    55.42 ns |  1.766 ns |  5.180 ns |    55.51 ns |      - |         - |\n|           StringComparison_Equals_b_Start |     10 |    46.70 ns |  0.973 ns |  1.965 ns |    46.41 ns |      - |         - |\n|             StringComparison_Equals_b_End |     10 |    81.11 ns |  1.815 ns |  5.236 ns |    80.42 ns |      - |         - |\n|         StringComparison_EqualityOperator |     10 |    79.07 ns |  2.444 ns |  7.168 ns |    77.24 ns | 0.0229 |      96 B |\n| StringComparison_EqualityOperator_b_Start |     10 |    80.76 ns |  2.589 ns |  7.551 ns |    79.09 ns | 0.0229 |      96 B |\n|   StringComparison_EqualityOperator_b_End |     10 |    86.48 ns |  2.763 ns |  8.016 ns |    85.40 ns | 0.0229 |      96 B |\n|                   StringComparison_Equals |    100 |   131.51 ns |  2.654 ns |  7.485 ns |   128.91 ns |      - |         - |\n|           StringComparison_Equals_b_Start |    100 |    51.06 ns |  1.427 ns |  4.162 ns |    49.94 ns |      - |         - |\n|             StringComparison_Equals_b_End |    100 |   410.15 ns | 10.802 ns | 31.849 ns |   403.00 ns |      - |         - |\n|         StringComparison_EqualityOperator |    100 |   246.99 ns |  4.642 ns |  4.342 ns |   246.59 ns | 0.1070 |     448 B |\n| StringComparison_EqualityOperator_b_Start |    100 |   243.33 ns |  2.462 ns |  2.056 ns |   243.46 ns | 0.1070 |     448 B |\n|   StringComparison_EqualityOperator_b_End |    100 |   260.33 ns |  5.702 ns | 16.176 ns |   253.08 ns | 0.1070 |     448 B |\n|                   StringComparison_Equals |   1000 |   878.83 ns |  7.949 ns |  7.047 ns |   878.38 ns |      - |         - |\n|           StringComparison_Equals_b_Start |   1000 |    46.50 ns |  0.944 ns |  0.883 ns |    46.13 ns |      - |         - |\n|             StringComparison_Equals_b_End |   1000 | 3,291.64 ns | 27.859 ns | 26.060 ns | 3,283.96 ns |      - |         - |\n|         StringComparison_EqualityOperator |   1000 | 2,001.56 ns | 31.459 ns | 27.888 ns | 1,993.78 ns | 0.9670 |   4,048 B |\n| StringComparison_EqualityOperator_b_Start |   1000 | 1,966.92 ns | 32.515 ns | 28.824 ns | 1,967.16 ns | 0.9670 |   4,048 B |\n|   StringComparison_EqualityOperator_b_End |   1000 | 2,002.98 ns | 39.681 ns | 30.980 ns | 1,997.75 ns | 0.9670 |   4,048 B |\n\n```\n\nAs you can seee in the above table, the `Equals` method is sometimes faster, but does not allocate any memory.\n\n\nThe biggest difference is, when the strings differ in the first character.\nIt takes about the same time to compare string with 10, 100 and 1000 if they differ at the start.\nIn contrast to that, with `EqualityOperator` this cannot be seen.\n\n\nFor the version with `EqualityOperator` it takes the same time, no matter where the difference is.\nThis is not true for the `Equals`, this gets faster, the earlier the difference is.\nThis is probably only because of the `ToLower()` in the first place.\n\n\nIn addition, memory is allocated when using `EqualityOperator` with `ToLower()`.\nThat's because of a new instance with all lowercased letters has to be created.\nSee: [String.ToLower Method - Microsoft Docs](https://docs.microsoft.com/en-us/dotnet/api/system.string.tolower?view=net-6.0)\n\n\nAdditional memory allocations are bad because the garbage collector needs to clean them up again,\nwhich will cost valuable CPU time and therefore slows down the application\n\n\n## Summary\n\nDon't use `ToLower()` when comparing strings (neither use `ToUpper()`).\nThis also applies to related string operations like `StartsWith()`, `EndsWith()`, `Contains()` and so on.\nI also interpret this as a code smell, because the available language features are not used.\nIn addition, some IDE's even detect this smell.\n\nAs always, the code can be found at my [GitHub](https://github.com/davidkroell/davidkroell.com/tree/main/content/blogposts/2022/dont-use-tolower-to-compare-strings/src).\nThere you can also find the benchmark report in CSV format.\n\n\n","html":"<p>When comparing strings, often the casing should be ignored in the comparison.\nMost of the times, this is required because every user writes text different.\nI do not really care when there is “Apple” or “apple” in a dataset.\nTo me, this is the same.\nOn the other side, “A” and “a” are different characters for computers.</p>\n<p>To overcome this problem, a working and very wide-spread approach is to first lowercase (or uppercase)\nall letters and then compare them.\nMost of us done it, me too - but no longer.\nAlthough there is a drawback you should keep in mind when it comes to performance.</p>\n<p>I’ve created a litte benchmark program an I’ll evaluate the results afterwards.\nFirst I’ll explain the benchmark setup.</p>\n<h2>Benchmark setup</h2>\n<p>I’ve evaluated three types of string equality comparison.</p>\n<ol>\n<li>Strings which are equal (except casing)</li>\n<li>Strings which are not equal, differing in the <strong>last</strong> character</li>\n<li>Strings which are not equal, differing in the <strong>first</strong> character</li>\n</ol>\n<p>These three test-cases were applied to string with lengths of 10, 100 and 1000 characters</p>\n<p>My benchmark code looks like the below code snippet, where <code class=\"language-text\">StringToCheck</code> and <code class=\"language-text\">VerifyString</code> are generated.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Benchmark</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">StringComparison_Equals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> result <span class=\"token operator\">=</span> StringToCheck<span class=\"token punctuation\">.</span><span class=\"token function\">Equals</span><span class=\"token punctuation\">(</span>VerifyString<span class=\"token punctuation\">,</span> StringComparison<span class=\"token punctuation\">.</span>CurrentCultureIgnoreCase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Benchmark</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">StringComparison_EqualityOperator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> result <span class=\"token operator\">=</span> StringToCheck<span class=\"token punctuation\">.</span><span class=\"token function\">ToLower</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> VerifyString<span class=\"token punctuation\">.</span><span class=\"token function\">ToLower</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Benchmark results</h2>\n<p>I’ve used <a href=\"https://github.com/dotnet/BenchmarkDotNet\"><code class=\"language-text\">BenchmarkDotNet</code></a>\nto run my test and enable the <code class=\"language-text\">MemoryDiagnoser</code> to also anaylse memory usage/allocations.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">BenchmarkDotNet=v0.13.1, OS=Windows 10.0.19044.1526 (21H2)\nIntel Core i7-8650U CPU 1.90GHz (Kaby Lake R), 1 CPU, 8 logical and 4 physical cores\n.NET SDK=6.0.101\n  [Host]     : .NET 6.0.1 (6.0.121.56705), X64 RyuJIT\n  DefaultJob : .NET 6.0.1 (6.0.121.56705), X64 RyuJIT\n\n\n|                                    Method | Length |        Mean |     Error |    StdDev |      Median |  Gen 0 | Allocated |\n|------------------------------------------ |------- |------------:|----------:|----------:|------------:|-------:|----------:|\n|                   StringComparison_Equals |     10 |    55.42 ns |  1.766 ns |  5.180 ns |    55.51 ns |      - |         - |\n|           StringComparison_Equals_b_Start |     10 |    46.70 ns |  0.973 ns |  1.965 ns |    46.41 ns |      - |         - |\n|             StringComparison_Equals_b_End |     10 |    81.11 ns |  1.815 ns |  5.236 ns |    80.42 ns |      - |         - |\n|         StringComparison_EqualityOperator |     10 |    79.07 ns |  2.444 ns |  7.168 ns |    77.24 ns | 0.0229 |      96 B |\n| StringComparison_EqualityOperator_b_Start |     10 |    80.76 ns |  2.589 ns |  7.551 ns |    79.09 ns | 0.0229 |      96 B |\n|   StringComparison_EqualityOperator_b_End |     10 |    86.48 ns |  2.763 ns |  8.016 ns |    85.40 ns | 0.0229 |      96 B |\n|                   StringComparison_Equals |    100 |   131.51 ns |  2.654 ns |  7.485 ns |   128.91 ns |      - |         - |\n|           StringComparison_Equals_b_Start |    100 |    51.06 ns |  1.427 ns |  4.162 ns |    49.94 ns |      - |         - |\n|             StringComparison_Equals_b_End |    100 |   410.15 ns | 10.802 ns | 31.849 ns |   403.00 ns |      - |         - |\n|         StringComparison_EqualityOperator |    100 |   246.99 ns |  4.642 ns |  4.342 ns |   246.59 ns | 0.1070 |     448 B |\n| StringComparison_EqualityOperator_b_Start |    100 |   243.33 ns |  2.462 ns |  2.056 ns |   243.46 ns | 0.1070 |     448 B |\n|   StringComparison_EqualityOperator_b_End |    100 |   260.33 ns |  5.702 ns | 16.176 ns |   253.08 ns | 0.1070 |     448 B |\n|                   StringComparison_Equals |   1000 |   878.83 ns |  7.949 ns |  7.047 ns |   878.38 ns |      - |         - |\n|           StringComparison_Equals_b_Start |   1000 |    46.50 ns |  0.944 ns |  0.883 ns |    46.13 ns |      - |         - |\n|             StringComparison_Equals_b_End |   1000 | 3,291.64 ns | 27.859 ns | 26.060 ns | 3,283.96 ns |      - |         - |\n|         StringComparison_EqualityOperator |   1000 | 2,001.56 ns | 31.459 ns | 27.888 ns | 1,993.78 ns | 0.9670 |   4,048 B |\n| StringComparison_EqualityOperator_b_Start |   1000 | 1,966.92 ns | 32.515 ns | 28.824 ns | 1,967.16 ns | 0.9670 |   4,048 B |\n|   StringComparison_EqualityOperator_b_End |   1000 | 2,002.98 ns | 39.681 ns | 30.980 ns | 1,997.75 ns | 0.9670 |   4,048 B |</code></pre></div>\n<p>As you can seee in the above table, the <code class=\"language-text\">Equals</code> method is sometimes faster, but does not allocate any memory.</p>\n<p>The biggest difference is, when the strings differ in the first character.\nIt takes about the same time to compare string with 10, 100 and 1000 if they differ at the start.\nIn contrast to that, with <code class=\"language-text\">EqualityOperator</code> this cannot be seen.</p>\n<p>For the version with <code class=\"language-text\">EqualityOperator</code> it takes the same time, no matter where the difference is.\nThis is not true for the <code class=\"language-text\">Equals</code>, this gets faster, the earlier the difference is.\nThis is probably only because of the <code class=\"language-text\">ToLower()</code> in the first place.</p>\n<p>In addition, memory is allocated when using <code class=\"language-text\">EqualityOperator</code> with <code class=\"language-text\">ToLower()</code>.\nThat’s because of a new instance with all lowercased letters has to be created.\nSee: <a href=\"https://docs.microsoft.com/en-us/dotnet/api/system.string.tolower?view=net-6.0\">String.ToLower Method - Microsoft Docs</a></p>\n<p>Additional memory allocations are bad because the garbage collector needs to clean them up again,\nwhich will cost valuable CPU time and therefore slows down the application</p>\n<h2>Summary</h2>\n<p>Don’t use <code class=\"language-text\">ToLower()</code> when comparing strings (neither use <code class=\"language-text\">ToUpper()</code>).\nThis also applies to related string operations like <code class=\"language-text\">StartsWith()</code>, <code class=\"language-text\">EndsWith()</code>, <code class=\"language-text\">Contains()</code> and so on.\nI also interpret this as a code smell, because the available language features are not used.\nIn addition, some IDE’s even detect this smell.</p>\n<p>As always, the code can be found at my <a href=\"https://github.com/davidkroell/davidkroell.com/tree/main/content/blogposts/2022/dont-use-tolower-to-compare-strings/src\">GitHub</a>.\nThere you can also find the benchmark report in CSV format.</p>","timeToRead":4,"fields":{"slug":"/blog/2022/dont-use-tolower-to-compare-strings/"},"frontmatter":{"title":"Don't use String.ToLower() in C# when comparing strings","date":"March 15, 2022","description":"Using String.ToLower() to compare strings with different casing can impact the performance of your C# apps","image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwT/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABzMdlZIP/xAAaEAEAAQUAAAAAAAAAAAAAAAABABAREiEy/9oACAEBAAEFAsSt4cu3/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGBAAAgMAAAAAAAAAAAAAAAAAARARITH/2gAIAQEABj8CwOBT/8QAGxAAAgIDAQAAAAAAAAAAAAAAAREAITFRgWH/2gAIAQEAAT8hFbuxEyqW4RsDplChMH2Eadlg4n//2gAMAwEAAgADAAAAELfv/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQMBAT8Qiv/EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAECAQE/EBn/xAAdEAEBAAICAwEAAAAAAAAAAAABEQAhMVFBYXHh/9oACAEBAAE/EAL1kC+e33k7ZTK7MG7T2jgLICA6V5cop0KPofuSSW8x5c//2Q==","aspectRatio":1.492537313432836,"src":"/static/910b4193cf00f7f1b74fc72e82f9bbca/2f1b1/amador-loureiro-BVyNlchWqzs-unsplash.jpg","srcSet":"/static/910b4193cf00f7f1b74fc72e82f9bbca/fd013/amador-loureiro-BVyNlchWqzs-unsplash.jpg 200w,\n/static/910b4193cf00f7f1b74fc72e82f9bbca/25252/amador-loureiro-BVyNlchWqzs-unsplash.jpg 400w,\n/static/910b4193cf00f7f1b74fc72e82f9bbca/2f1b1/amador-loureiro-BVyNlchWqzs-unsplash.jpg 800w,\n/static/910b4193cf00f7f1b74fc72e82f9bbca/0ff54/amador-loureiro-BVyNlchWqzs-unsplash.jpg 1200w,\n/static/910b4193cf00f7f1b74fc72e82f9bbca/06655/amador-loureiro-BVyNlchWqzs-unsplash.jpg 1600w,\n/static/910b4193cf00f7f1b74fc72e82f9bbca/097fa/amador-loureiro-BVyNlchWqzs-unsplash.jpg 1920w","sizes":"(max-width: 800px) 100vw, 800px"}}}}}},"pageContext":{"slug":"/blog/2022/dont-use-tolower-to-compare-strings/","previous":{"fields":{"slug":"/blog/2022/boost-async-code-in-csharp/"},"frontmatter":{"title":"A Simple Trick to Boost Performance of Async Code in C#","categories":["programming"]}},"next":{"fields":{"slug":"/blog/2022/timescoped-registration-with-ms-di/"},"frontmatter":{"title":"A Time-Scoped Registration Mechanism for Microsoft .Extensions.DependencyInjection","categories":["programming"]}}}},"staticQueryHashes":["143701507","3649515864"]}