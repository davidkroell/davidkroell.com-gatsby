{"componentChunkName":"component---src-templates-blogs-post-js","path":"/blog/2021/homemade-di-the-hows-and-whys-of-dependency-injection/","result":{"data":{"site":{"siteMetadata":{"title":"David Kröll"}},"markdownRemark":{"id":"7089b823-8746-5c05-b3ac-9aafc525d52f","excerpt":"Once upon a time, a junior developer asked himself:\n“What is this dependency injection thing that all the seniors are talking about?”\nHe…","rawMarkdownBody":"\nOnce upon a time, a junior developer asked himself:\n\"What is this dependency injection thing that all the seniors are talking about?\"\nHe know how to use it, but he was not familiar with the principles behind it,\nnor he fully understood why all of them are using it.\n\nOnce, I've been this developer, but now I'm one of the seniors who believe that dependency injection (DI)\nis a very important and useful concept we all should be familiar with.\nThen I sometimes thought how hard could it be to create a DI framework myself?\nHow hard could it be to create some instances of classes which are registered first?\nIt's not magic, neither is it hard.\nI'd like to show you now how to do it - and maybe it will help you understand it better.\n\n## Why Dependency Injection?\n\nObviously, we do not implement DI as an end in itself.\nThere is a problem we can solve with DI and it's solution is called\n**Dependency Inversion Principle** (the D of SOLI**D**, DIP abbreviated).\n\nAssume an implementation like the following:\n```csharp\npublic class PeopleService\n{\n    private readonly PeopleRepository _peopleRepository;\n\n    public PeopleService()\n    {\n        _peopleRepository = new PeopleRepository();\n    }\n}\n```\n\nThe problem here is the creation dependency (the `new` keyword) to `PeopleRepository`.\n\n![Hard and direct (bad) dependency between classes](hard-dependency.png)\n\n*Hard and direct (bad) dependency between classes*\n\nTherefore a hard coupling between `PeopleService` and `PeopleRepository` is created.\nWhenever a PeopleService gets created, also a `PeopleRepository` instance gets created.\nExactly this PeopleRepository is instantiated and there is no change to supply another implementation.\nHard coupling between these two is the result.\n\nWe don't want this due to various reasons.\nFirst of all, it's bad for code quality, as the quality attributes **testability** and **changeability**\ncannot be met.\n\nFurthermore, we cannot provide a mock instance to the `PeopleService` in order to write a unit test for it.\nThe solution to this problem is to pull the creation dependency (the `new`) up to the consumer\nof the `PeopleService`.\n\n![The dependency is now inversed, it's the responsibility of whoever wants to use the\nPeopleService to pass an instance of IPeopleRepository](inversed-dependency.png)\n\n*The dependency is now inversed, it's the responsibility of whoever wants to use the\nPeopleService to pass an instance of IPeopleRepository*\n\nIt's now his responsibility to supply a correct instance of `IPeopleRepository` to the `PeopleService`.\n\n```csharp\npublic class PeopleService\n{\n    private readonly PeopleRepository _peopleRepository;\n\n    public PeopleService(IPeopleRepository peopleRepository)\n    {\n        _peopleRepository = peopleRepository;\n    }\n}\n```\n\nAs you can infer from the naming, we'll use an interface type here as dependency,\nin order to allow also supplying other implementations (e.g. for testing)\nto `PeopleService` to rely on.\nIt is also more clear which other classes are required for the `PeopleService` to work correctly.\n\n```csharp\nvar peopleService = new PeopleService(new PeopleRepository());\n// or with another (mock) implementation\nvar peopleService = new PeopleService(new MockPeopleRepository());\n```\n\n## Dependency Injection basics\n\nImagine you apply the **Dependency Inversion Principle** everywhere across your app.\nAt some point, all the instances of your classes have to be instantiated and passed to the dependent classes.\n\n![A dependency tree](dependency-tree.png)\n\n*A dependency tree*\n\nYou need `A` and `B` to create a PeopleService, but in order to create `A` you need `A1` and `A2`, and so on.\nAs you can see in the above graphic, a dependency tree arises.\nTherefore, you have to start at the bottom where no dependencies are required (`A11` and `A12` here)\nand work your way up, until you got a `PeopleService`.\n\nIf something is added, removed or moved around inside this tree, you have to adjust it yourself.\nEspecially for large-scale applications with hundreds of classes this soon gets\nimpractical and unmaintainable (again, a quality attribute).\n\nThis is where dependency injection comes to the rescue. It's a technique which creates these instances for you and\ncopes with all it's dependencies. The only thing you'd like to do is to have a small library\nwhich you can call: I'd like to have an instance of `PeopleService`, could you give me some?\n\n```csharp\nvar peopleService = serviceLibrary.GetService<PeopleService>();\n```\n\nStill assuming we use interfaces as constructor parameters (to be more flexible, you remember)\nwe have to tell the DI framework which concrete implementations will be behind them.\nWe have to register in the first place which implementation should be used for which interface,\nbecause there can be different implementations for different scenarios.\n\nThis will result in a table-like structure with a mapping from the interface-type to the implementation-type.\n\n| Interface | Implementation |\n| --- | --- |\n| IPeopleService | PeopleService |\n| IPeopleRepository | PeopleRepository |\n| ITestDependencyX | TestDependencyX |\n\n## Implementation\n\nThere are two different use-cases for a DI framework to cover:\n\n* mapping a interface-implementation type pair\n* resolving a instance from it, based on a interface type\n\nI'll call my dependency injection framework `ServiceLibrary`.\nOnly a single class will be used, since it does not get too much code.\nIn consequence all the code snippets below reside in the `ServiceLibrary` class.\n\n### Mapping types\n\nWe'll start off with the easy part.\nAs you can see below, the basic implementation is very simple.\n\n```csharp\nprivate readonly Dictionary<Type, Type> _mappings = new();\n\npublic void Map(Type interfaceType, Type implementationType)\n{\n    _mappings[interfaceType] = implementationType;\n}\n\n// generic method for easier use\npublic void Map<TInterface, TImpl>()\n{\n    var interfaceType = typeof(TInterface);\n    var implementationType = typeof(TImpl);\n\n    Map(interfaceType, implementationType);\n}\n```\n\nOf course additional checks can be added to this snippet, for example:\n* Is this interface already registered?\n* Does the implementation type even implement this interface?\n* Is it possible to create a instance of the implementation type?\n\n\n### Resolving mapped types\n\nWhen you'd like to retrieve an instance of a specific interface type,\na lookup based on the `_mappings` has to be made.\nDepending on the concrete implementation type, all the dependencies for it\nalso have to be evaluated and built.\nThe above explanation is summarized in the following graphic:\n\n![How the service resolve works with interfaces and mappings](getservice-summary.png)\n\n*How the service resolve works with interfaces and mappings*\n\n\nThis is possible by using reflection, since all dependencies are listed inside\nthe constructor and C# allows us to scan the constructor definition of any type.\nHow this works in code is shown below.\n\n```csharp\nprivate Type[] GetDependentTypes(Type implType)\n{\n    // retrieve constructor info\n    var ctorInfo = implType.GetConstructors()\n        .First();\n\n    var parameterInfos = ctorInfo.GetParameters();\n\n    if (parameterInfos.Length == 0)\n    {\n        return Array.Empty<Type>();\n    }\n\n    // only return the types of the parameters\n    return parameterInfos.Select(x => x.ParameterType)\n        .ToArray();\n}\n```\n\nThe below snippet shows how the creation of the instances is done.\nIt's implemented in a recursive manner because of the tree-structure which\nmay result depending on which types you register upfront.\n\n```csharp\npublic object GetService(Type type)\n{\n    // lookup in the registered mappings\n    var implType = _mappings[type];\n    var dependentTypes = GetDependentTypes(implType);\n\n    if (dependentTypes.Length == 0)\n    {\n        // no dependencies for this type (parameterless constructor)\n        return Activator.CreateInstance(implType);\n    }\n\n    // create all dependencies to create this service\n    var dependentInstances = new object[dependentTypes.Length];\n\n    for (var i = 0; i < dependentTypes.Length; i++)\n    {\n        // traverse the tree with recursion\n        dependentInstances[i] = GetService(dependentTypes[i]);\n    }\n\n    return Activator.CreateInstance(implType, dependentInstances);\n}\n```\n\nI left out some null-handling and edge-cases here, but basically that's it.\nWe can now add an generic method to make the library more easy to use:\n\n```csharp\npublic T GetService<T>()\n{\n    return (T) GetService(typeof(T));\n}\n```\n\n\n## Usage\n\nThe implementation is now done, it's time to use it.\nWe'll use the generic methods we created, since this is easier in my opinion.\nWe just have to register all our interface-implementation type mappings first,\nand afterwards we are able to resolve an interface from it.\n\n```csharp\nvar sl = new ServiceLibrary();\n\n// register\nsl.Map<IPeopleService, PeopleService>();\nsl.Map<ITestDependencyX, TestDependencyX>();\nsl.Map<ITestDependencyY, TestDependencyY>();\n\n// resolve\nvar peopleService = sl.GetService<IPeopleService>();\n```\n\n## Conclusion\n\nI haven't thought implementing a fully functional DI framework would be so straightforward upfront.\nHowever the more I thought about it, the easier it got.\nNevertheless there are more use-cases which can be covered with DI,\nfor example service lifetime management (singletons) just to name one.\n\nI hope the concept of dependency injection is clear to you now.\nFeel free to look up the final code  on [GitHub](https://github.com/davidkroell/homemade-di) as I worked a little bit on it\nfor improvements and also tested it for the various use-cases. \n\n","html":"<p>Once upon a time, a junior developer asked himself:\n“What is this dependency injection thing that all the seniors are talking about?”\nHe know how to use it, but he was not familiar with the principles behind it,\nnor he fully understood why all of them are using it.</p>\n<p>Once, I’ve been this developer, but now I’m one of the seniors who believe that dependency injection (DI)\nis a very important and useful concept we all should be familiar with.\nThen I sometimes thought how hard could it be to create a DI framework myself?\nHow hard could it be to create some instances of classes which are registered first?\nIt’s not magic, neither is it hard.\nI’d like to show you now how to do it - and maybe it will help you understand it better.</p>\n<h2>Why Dependency Injection?</h2>\n<p>Obviously, we do not implement DI as an end in itself.\nThere is a problem we can solve with DI and it’s solution is called\n<strong>Dependency Inversion Principle</strong> (the D of SOLI<strong>D</strong>, DIP abbreviated).</p>\n<p>Assume an implementation like the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PeopleService</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">PeopleRepository</span> _peopleRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">PeopleService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _peopleRepository <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PeopleRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The problem here is the creation dependency (the <code class=\"language-text\">new</code> keyword) to <code class=\"language-text\">PeopleRepository</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 371px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/05f7fc90305c828721a20de0fa1a80d6/d4635/hard-dependency.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.89189189189189%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAwElEQVQI1z1OOw6CQBTcAlsqKylNrO1suAGtB/A4xJpzwAE4hq0kfAtEEtbduLuoO74tYJLJTF7emzesaRorhLBSykV/Sin0fc/zPN8zAgC2AGm6wzCM0BqgXaJdOU2WuWMKQVEUqOsabdvCzeZ5lkmSHCnDC4LAD7Zbn/zmermc5mmS9BG434GyBKoK6Do4sHEcDR0bzrmhYEMtldb6S/rMsuzgWkVR5J3D0HP+Fsf73+v1wPv9tZwrCGFWfj7mDy9+smapB5HrAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Hard and direct (bad) dependency between classes\"\n        title=\"Hard and direct (bad) dependency between classes\"\n        src=\"/static/05f7fc90305c828721a20de0fa1a80d6/d4635/hard-dependency.png\"\n        srcset=\"/static/05f7fc90305c828721a20de0fa1a80d6/12f09/hard-dependency.png 148w,\n/static/05f7fc90305c828721a20de0fa1a80d6/e4a3f/hard-dependency.png 295w,\n/static/05f7fc90305c828721a20de0fa1a80d6/d4635/hard-dependency.png 371w\"\n        sizes=\"(max-width: 371px) 100vw, 371px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><em>Hard and direct (bad) dependency between classes</em></p>\n<p>Therefore a hard coupling between <code class=\"language-text\">PeopleService</code> and <code class=\"language-text\">PeopleRepository</code> is created.\nWhenever a PeopleService gets created, also a <code class=\"language-text\">PeopleRepository</code> instance gets created.\nExactly this PeopleRepository is instantiated and there is no change to supply another implementation.\nHard coupling between these two is the result.</p>\n<p>We don’t want this due to various reasons.\nFirst of all, it’s bad for code quality, as the quality attributes <strong>testability</strong> and <strong>changeability</strong>\ncannot be met.</p>\n<p>Furthermore, we cannot provide a mock instance to the <code class=\"language-text\">PeopleService</code> in order to write a unit test for it.\nThe solution to this problem is to pull the creation dependency (the <code class=\"language-text\">new</code>) up to the consumer\nof the <code class=\"language-text\">PeopleService</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 443px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5e0a71b227195eb4ac27397d762a57fb/a120c/inversed-dependency.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.48648648648649%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAABVElEQVQoz52T646DIBCFff+360+b3lOvFdGKgAKedaaxcZtN0+7oCRrwc+YMRFmWoWkaCCFYbduiLEsMwwDvPZxzCD5AGIHa1SzhBEs6iZu7IUwBFNM0Ier7noFJkoDg9E663+88KqWge41LeYFyCufhjKM94mRPKMcSOujfwKqqoLXmD0kEqeuaJ9dh5qvzHZRXrOWZMiYgrWfgUhaNay0L1ppnEF6u14jwJjhLvh/Zejf/fHQYxxHBBTS2QaxjbM0We7vHwR4Q/ZXJoieUSjaG7bDWsgY7QGqJTGYw3rCXJpj3Ga6BS7PyPEeapiiKAo1suGFTmD4reQ3sug7LjiBJKaG6uYltD0z4HkiNot1A5RpruGTRC2zkBrGJsbM79vFjIIGeQPMA1rpG0RbsIfn3lYdUJvlGp4jGLM9Q3SpUZfW/kulIXq/XZ1NISZrwCVvviB9ng6jS3Y995gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"The dependency is now inversed, it&#39;s the responsibility of whoever wants to use the\nPeopleService to pass an instance of IPeopleRepository\"\n        title=\"The dependency is now inversed, it&#39;s the responsibility of whoever wants to use the\nPeopleService to pass an instance of IPeopleRepository\"\n        src=\"/static/5e0a71b227195eb4ac27397d762a57fb/a120c/inversed-dependency.png\"\n        srcset=\"/static/5e0a71b227195eb4ac27397d762a57fb/12f09/inversed-dependency.png 148w,\n/static/5e0a71b227195eb4ac27397d762a57fb/e4a3f/inversed-dependency.png 295w,\n/static/5e0a71b227195eb4ac27397d762a57fb/a120c/inversed-dependency.png 443w\"\n        sizes=\"(max-width: 443px) 100vw, 443px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><em>The dependency is now inversed, it’s the responsibility of whoever wants to use the\nPeopleService to pass an instance of IPeopleRepository</em></p>\n<p>It’s now his responsibility to supply a correct instance of <code class=\"language-text\">IPeopleRepository</code> to the <code class=\"language-text\">PeopleService</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">PeopleService</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">PeopleRepository</span> _peopleRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">PeopleService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IPeopleRepository</span> peopleRepository<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _peopleRepository <span class=\"token operator\">=</span> peopleRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As you can infer from the naming, we’ll use an interface type here as dependency,\nin order to allow also supplying other implementations (e.g. for testing)\nto <code class=\"language-text\">PeopleService</code> to rely on.\nIt is also more clear which other classes are required for the <code class=\"language-text\">PeopleService</code> to work correctly.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> peopleService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PeopleService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PeopleRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// or with another (mock) implementation</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> peopleService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PeopleService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">MockPeopleRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Dependency Injection basics</h2>\n<p>Imagine you apply the <strong>Dependency Inversion Principle</strong> everywhere across your app.\nAt some point, all the instances of your classes have to be instantiated and passed to the dependent classes.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 461px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8f351dcc8f29abcb1da3abf15e67f5c5/f816d/dependency-tree.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAABbUlEQVQ4y43TB44DMQgFUN//lpHS+6R3Vs8SIyubLUjIhoHPBzNlMpnEdruN1WpV1X0+n8ftdov7/f5vfTweQcrxeKwgo9EoptNpnE6nOBwOsd/v6+n7ZrOJruvqvfXtdrt6p+Kv12uU5XLZg2SC4FbO53PVVoA9n8/eBia3cKLbKt/r9aqBWp/NZlUV5MfWqNbrdbUVM6bxeBwlfpAEFKwDhbSlGHbmlraTXC6XKBLftRVBAIBmopmzMcwCGVc+sXKaCZW4WCxqshlJ1DI/9hnLNpLyDqYVL26FBAEwL74EwXQ4HH57qLo2CZaAqktA34NQvlyljFHINuT+JUZ5n5tEldHXCkDg/LR9BLaO2g77lnOnDFxlChATvlxe4lvua+b1gCoYerYkcTAY9G2yLb97m/jpMSughQWoLQLUkqqe/ymbJsNPa9YzxERrmKDf/q/mp+Wc028se4ZWAjttCbRvlA3MA1khMfx/AX4BiYKRg8nUZ6MAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"A dependency tree\"\n        title=\"A dependency tree\"\n        src=\"/static/8f351dcc8f29abcb1da3abf15e67f5c5/f816d/dependency-tree.png\"\n        srcset=\"/static/8f351dcc8f29abcb1da3abf15e67f5c5/12f09/dependency-tree.png 148w,\n/static/8f351dcc8f29abcb1da3abf15e67f5c5/e4a3f/dependency-tree.png 295w,\n/static/8f351dcc8f29abcb1da3abf15e67f5c5/f816d/dependency-tree.png 461w\"\n        sizes=\"(max-width: 461px) 100vw, 461px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><em>A dependency tree</em></p>\n<p>You need <code class=\"language-text\">A</code> and <code class=\"language-text\">B</code> to create a PeopleService, but in order to create <code class=\"language-text\">A</code> you need <code class=\"language-text\">A1</code> and <code class=\"language-text\">A2</code>, and so on.\nAs you can see in the above graphic, a dependency tree arises.\nTherefore, you have to start at the bottom where no dependencies are required (<code class=\"language-text\">A11</code> and <code class=\"language-text\">A12</code> here)\nand work your way up, until you got a <code class=\"language-text\">PeopleService</code>.</p>\n<p>If something is added, removed or moved around inside this tree, you have to adjust it yourself.\nEspecially for large-scale applications with hundreds of classes this soon gets\nimpractical and unmaintainable (again, a quality attribute).</p>\n<p>This is where dependency injection comes to the rescue. It’s a technique which creates these instances for you and\ncopes with all it’s dependencies. The only thing you’d like to do is to have a small library\nwhich you can call: I’d like to have an instance of <code class=\"language-text\">PeopleService</code>, could you give me some?</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> peopleService <span class=\"token operator\">=</span> serviceLibrary<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>PeopleService<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Still assuming we use interfaces as constructor parameters (to be more flexible, you remember)\nwe have to tell the DI framework which concrete implementations will be behind them.\nWe have to register in the first place which implementation should be used for which interface,\nbecause there can be different implementations for different scenarios.</p>\n<p>This will result in a table-like structure with a mapping from the interface-type to the implementation-type.</p>\n<table>\n<thead>\n<tr>\n<th>Interface</th>\n<th>Implementation</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>IPeopleService</td>\n<td>PeopleService</td>\n</tr>\n<tr>\n<td>IPeopleRepository</td>\n<td>PeopleRepository</td>\n</tr>\n<tr>\n<td>ITestDependencyX</td>\n<td>TestDependencyX</td>\n</tr>\n</tbody>\n</table>\n<h2>Implementation</h2>\n<p>There are two different use-cases for a DI framework to cover:</p>\n<ul>\n<li>mapping a interface-implementation type pair</li>\n<li>resolving a instance from it, based on a interface type</li>\n</ul>\n<p>I’ll call my dependency injection framework <code class=\"language-text\">ServiceLibrary</code>.\nOnly a single class will be used, since it does not get too much code.\nIn consequence all the code snippets below reside in the <code class=\"language-text\">ServiceLibrary</code> class.</p>\n<h3>Mapping types</h3>\n<p>We’ll start off with the easy part.\nAs you can see below, the basic implementation is very simple.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">Dictionary<span class=\"token punctuation\">&lt;</span>Type<span class=\"token punctuation\">,</span> Type<span class=\"token punctuation\">></span></span> _mappings <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Type</span> interfaceType<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Type</span> implementationType<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    _mappings<span class=\"token punctuation\">[</span>interfaceType<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> implementationType<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// generic method for easier use</span>\n<span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token generic-method\"><span class=\"token function\">Map</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>TInterface<span class=\"token punctuation\">,</span> TImpl<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> interfaceType <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">TInterface</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> implementationType <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">TImpl</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">Map</span><span class=\"token punctuation\">(</span>interfaceType<span class=\"token punctuation\">,</span> implementationType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Of course additional checks can be added to this snippet, for example:</p>\n<ul>\n<li>Is this interface already registered?</li>\n<li>Does the implementation type even implement this interface?</li>\n<li>Is it possible to create a instance of the implementation type?</li>\n</ul>\n<h3>Resolving mapped types</h3>\n<p>When you’d like to retrieve an instance of a specific interface type,\na lookup based on the <code class=\"language-text\">_mappings</code> has to be made.\nDepending on the concrete implementation type, all the dependencies for it\nalso have to be evaluated and built.\nThe above explanation is summarized in the following graphic:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/938c5db88b8e61aabf6e8fdaefb9d9ca/487bb/getservice-summary.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.32432432432432%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABkUlEQVQoz3VS25aDIAz0//+vL32yrdVa8Y6ACsxOaN12H5ZzIiHgZDJJBq5pmlCVFZ7DE8VSoNQlVKsQQpRrvL6fXd63bYvb7Ybz+YzT6ZT8ruuQyYN5njGNE6ZlQmc6DGaAMeYXJIr/fCLSsO/QWqMgwOVygVIKTdPger2iqipkMUYc5neP1a4J5Q8rJkRdIxIAwwBNJuX9jjtNmNa8K4oCj8fjxfBY275h1CO9gEjw6ByitYjryvP+AmfikUyEkQAKiICJlWWJzHufwHzwqF2Naq3gVjJaN+KGBPDJyBjBF5b+4M81d9FNGAqwlJ7JRwJCfZxGWGMJ6GCchXXir3Bkalmq473Ae2poqatl3L3NshLZs3EcU1MWvaRGHIytZqme2vIcloXsApwlw80nlv+tLLCs1BD58e2rXSGf8yRBJMtA/ZRvkescjcTeen439LDUFAEaWJLMl5TdzR2cd1B9wzPHaZ5SbIsb9vhpTkzjEP8yPAD7vk8CiwRmMQieSfohxSSRaBvfg/4C+5r0r/UD21cG7ifhLaMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"How the service resolve works with interfaces and mappings\"\n        title=\"How the service resolve works with interfaces and mappings\"\n        src=\"/static/938c5db88b8e61aabf6e8fdaefb9d9ca/fcda8/getservice-summary.png\"\n        srcset=\"/static/938c5db88b8e61aabf6e8fdaefb9d9ca/12f09/getservice-summary.png 148w,\n/static/938c5db88b8e61aabf6e8fdaefb9d9ca/e4a3f/getservice-summary.png 295w,\n/static/938c5db88b8e61aabf6e8fdaefb9d9ca/fcda8/getservice-summary.png 590w,\n/static/938c5db88b8e61aabf6e8fdaefb9d9ca/487bb/getservice-summary.png 698w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><em>How the service resolve works with interfaces and mappings</em></p>\n<p>This is possible by using reflection, since all dependencies are listed inside\nthe constructor and C# allows us to scan the constructor definition of any type.\nHow this works in code is shown below.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token return-type class-name\">Type<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> <span class=\"token function\">GetDependentTypes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Type</span> implType<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// retrieve constructor info</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> ctorInfo <span class=\"token operator\">=</span> implType<span class=\"token punctuation\">.</span><span class=\"token function\">GetConstructors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">First</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> parameterInfos <span class=\"token operator\">=</span> ctorInfo<span class=\"token punctuation\">.</span><span class=\"token function\">GetParameters</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parameterInfos<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> Array<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Empty</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Type<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// only return the types of the parameters</span>\n    <span class=\"token keyword\">return</span> parameterInfos<span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>ParameterType<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">ToArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The below snippet shows how the creation of the instances is done.\nIt’s implemented in a recursive manner because of the tree-structure which\nmay result depending on which types you register upfront.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token function\">GetService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Type</span> type<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// lookup in the registered mappings</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> implType <span class=\"token operator\">=</span> _mappings<span class=\"token punctuation\">[</span>type<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dependentTypes <span class=\"token operator\">=</span> <span class=\"token function\">GetDependentTypes</span><span class=\"token punctuation\">(</span>implType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dependentTypes<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// no dependencies for this type (parameterless constructor)</span>\n        <span class=\"token keyword\">return</span> Activator<span class=\"token punctuation\">.</span><span class=\"token function\">CreateInstance</span><span class=\"token punctuation\">(</span>implType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// create all dependencies to create this service</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dependentInstances <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\"><span class=\"token keyword\">object</span></span><span class=\"token punctuation\">[</span>dependentTypes<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> dependentTypes<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// traverse the tree with recursion</span>\n        dependentInstances<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">GetService</span><span class=\"token punctuation\">(</span>dependentTypes<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> Activator<span class=\"token punctuation\">.</span><span class=\"token function\">CreateInstance</span><span class=\"token punctuation\">(</span>implType<span class=\"token punctuation\">,</span> dependentInstances<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I left out some null-handling and edge-cases here, but basically that’s it.\nWe can now add an generic method to make the library more easy to use:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">T</span> <span class=\"token generic-method\"><span class=\"token function\">GetService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>T<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>T<span class=\"token punctuation\">)</span> <span class=\"token function\">GetService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">T</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Usage</h2>\n<p>The implementation is now done, it’s time to use it.\nWe’ll use the generic methods we created, since this is easier in my opinion.\nWe just have to register all our interface-implementation type mappings first,\nand afterwards we are able to resolve an interface from it.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> sl <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ServiceLibrary</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// register</span>\nsl<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Map</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>IPeopleService<span class=\"token punctuation\">,</span> PeopleService<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsl<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Map</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ITestDependencyX<span class=\"token punctuation\">,</span> TestDependencyX<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsl<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Map</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ITestDependencyY<span class=\"token punctuation\">,</span> TestDependencyY<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// resolve</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> peopleService <span class=\"token operator\">=</span> sl<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>IPeopleService<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Conclusion</h2>\n<p>I haven’t thought implementing a fully functional DI framework would be so straightforward upfront.\nHowever the more I thought about it, the easier it got.\nNevertheless there are more use-cases which can be covered with DI,\nfor example service lifetime management (singletons) just to name one.</p>\n<p>I hope the concept of dependency injection is clear to you now.\nFeel free to look up the final code  on <a href=\"https://github.com/davidkroell/homemade-di\">GitHub</a> as I worked a little bit on it\nfor improvements and also tested it for the various use-cases. </p>","timeToRead":7,"fields":{"slug":"/blog/2021/homemade-di-the-hows-and-whys-of-dependency-injection/"},"frontmatter":{"title":"Homemade DI: The How's and Why's of Dependency Injection (in dotnet)","date":"November 04, 2021","description":"How does Dependency Injection work, why developers apply it and how to implement a basic version yourself","image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAgADBf/EABUBAQEAAAAAAAAAAAAAAAAAAAEA/9oADAMBAAIQAxAAAAHkvBMJyf/EABkQAAIDAQAAAAAAAAAAAAAAAAECABASEf/aAAgBAQABBQJOacKLJLzM/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGBAAAgMAAAAAAAAAAAAAAAAAECEAARH/2gAIAQEABj8CcvCx/8QAHBABAAIBBQAAAAAAAAAAAAAAAQARIRAxccHw/9oACAEBAAE/IXgNjM57PutApu4hazOU/9oADAMBAAIAAwAAABBjH//EABYRAQEBAAAAAAAAAAAAAAAAABEBEP/aAAgBAwEBPxAg5//EABcRAAMBAAAAAAAAAAAAAAAAAAABESH/2gAIAQIBAT8Q2kZ//8QAHhABAAICAQUAAAAAAAAAAAAAAQARITFBUYHR4fD/2gAIAQEAAT8QaMQmOGxPHeKUFSrcVbrr7S4pGyNmJocY1D5J/9k=","aspectRatio":1.5037593984962405,"src":"/static/d9e1afc4effcc48720b39dedae27d6ed/2f1b1/sara-bakhshi-MfnX4XtGnvU-unsplash.jpg","srcSet":"/static/d9e1afc4effcc48720b39dedae27d6ed/fd013/sara-bakhshi-MfnX4XtGnvU-unsplash.jpg 200w,\n/static/d9e1afc4effcc48720b39dedae27d6ed/25252/sara-bakhshi-MfnX4XtGnvU-unsplash.jpg 400w,\n/static/d9e1afc4effcc48720b39dedae27d6ed/2f1b1/sara-bakhshi-MfnX4XtGnvU-unsplash.jpg 800w,\n/static/d9e1afc4effcc48720b39dedae27d6ed/0ff54/sara-bakhshi-MfnX4XtGnvU-unsplash.jpg 1200w,\n/static/d9e1afc4effcc48720b39dedae27d6ed/06655/sara-bakhshi-MfnX4XtGnvU-unsplash.jpg 1600w,\n/static/d9e1afc4effcc48720b39dedae27d6ed/097fa/sara-bakhshi-MfnX4XtGnvU-unsplash.jpg 1920w","sizes":"(max-width: 800px) 100vw, 800px"}}}}}},"pageContext":{"slug":"/blog/2021/homemade-di-the-hows-and-whys-of-dependency-injection/","previous":{"fields":{"slug":"/blog/2021/strategy-design-pattern-with-di/"},"frontmatter":{"title":"Strategy Design Pattern with Dependency Injection","categories":["programming"]}},"next":{"fields":{"slug":"/blog/2022/boost-async-code-in-csharp/"},"frontmatter":{"title":"A Simple Trick to Boost Performance of Async Code in C#","categories":["programming"]}}}},"staticQueryHashes":["143701507","3649515864"]}